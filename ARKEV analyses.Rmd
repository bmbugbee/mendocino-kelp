---
title: "ARKEV analyses"
output: pdf_document
date: "2025-10-24"
---
 
#Datasheet
```{r}
#installing packages
library(dplyr)
library(tidyr)
library(lubridate)
library(googlesheets4)
library(purrr)

#importing datasheet 
MASTER = read_sheet('https://docs.google.com/spreadsheets/d/1jhqeuVwg7_icGaYOh5YpMcoPubQsDs3fn9fWGcZmFi4/edit?gid=1766421584#gid=1766421584')

#creating the function that converts "NAs" to true NAs
to_numeric <- function(x) {
  map_dbl(x, ~ {
    # empty list â†’ NA
    if (length(.x) == 0) return(NA_real_)
    
    # if it's character, convert "NA" â†’ NA first
    if (is.character(.x)) {
      .x <- na_if(.x, "NA")
    }
    as.numeric(.x)
  })
}

doc_MASTER <- MASTER %>%
# turn "NA" strings in character columns into real NA
  mutate(across(where(is.character), ~ na_if(.x, "NA"))) %>%
# list-columns that are truly numeric-ish
  mutate(
    count   = to_numeric(count),
    percent = to_numeric(percent),
    depth_ft = to_numeric(depth_ft),
    temp_f   = to_numeric(temp_f)
  ) %>%
# handle size_cm specially
  mutate(
# keep the original category (<2cm, >2cm, numbers) as a character column "urchin_size_class"
    urch_size_class = map_chr(size_cm, ~ {
      if (length(.x) == 0) return(NA_character_)
      as.character(.x)
    }),
# numeric version: fish lengths only; urchin categories â†’ NA
    size_cm = map_dbl(size_cm, ~ {
      if (length(.x) == 0) return(NA_real_)
      if (is.character(.x)) {
# drop urchin categories from numeric column
        if (.x %in% c("<2cm", ">2cm")) return(NA_real_)
        .x <- na_if(.x, "NA")
      }
      as.numeric(.x)
    })
  ) %>%
  mutate(Date = make_date(year, month, day))
```

```{r}

kelp_data_full <- doc_MASTER %>%
  filter(data_type == "kelp")%>%
  # Fill in missing combos of ARKEV_type Ã— Date Ã— species_code
  complete(month, day, year, ARKEV_type, ARKEV_unit, data_type, Date, species_code, fill = list(count = 0))

  

kelp_summary_full <- kelp_data_full %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

kelp_data <- doc_MASTER %>%
  filter(data_type == "kelp")%>%
  filter(month != 10) %>%
  # Fill in missing combos of ARKEV_type Ã— Date Ã— species_code
  complete(month, day, year, ARKEV_type, ARKEV_unit, data_type, Date, species_code, fill = list(count = 0))

kelp_summary <- kelp_data %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )
View(kelp_data_full)
```

```{r}
library(ggplot2)

ggplot(kelp_summary_full, aes(x = Date, y = mean_count, color = ARKEV_type, group = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))

#Removing October Month 
ggplot(kelp_summary, aes(x = Date, y = mean_count, color = ARKEV_type, group = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))
```
```{r}
kelp_total_abundance <- kelp_summary %>%
  group_by(ARKEV_type) %>%
  summarise(
    mean_count = mean(mean_count, na.rm = TRUE),                 # average over dates
    se_count = sqrt(sum(se_count^2) / n()),                     # combine SE across dates
    .groups = "drop"
  )
```

```{r}
library(ggplot2)

ggplot(kelp_total_abundance, aes(x = ARKEV_type, y = mean_count)) +
  geom_col(color = "black", show.legend = FALSE) +
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
                width = 0.3, color = "black") +
  labs(
    title = "Overall Mean Kelp Abundance by ARKEV Type",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per mÂ²)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
```

```{r}
kelp_species_summary <- kelp_data %>%
  filter(!species_code %in% c("NO_KELP", "STUMP")) %>%
  group_by(Date, ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

kelp_monthly <- kelp_species_summary %>%
  group_by(Date, ARKEV_type) %>%
  mutate(
    percent_count = (mean_count / sum(mean_count)) * 100
  ) %>%
  ungroup()

```

```{r}
library(ggplot2)

ggplot(kelp_species_summary, aes(x = Date, y = mean_count, fill = species_code)) +
  geom_col(position = "stack", color = "black") +
  facet_wrap(~ ARKEV_type) +
  labs(
    title = "Kelp Species Composition by ARKEV Type Over Time",
    x = "Date",
    y = "Mean Kelp Count (per mÂ²)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  )

library(ggplot2)

ggplot(kelp_monthly, aes(x = Date, y = percent_count, fill = species_code)) +
  geom_col(color = "black", position = "stack") +
  facet_wrap(~ ARKEV_type) +
  labs(
    title = "Relative Kelp Species Composition",
    x = "Month",
    y = "Percent of Total Kelp (%)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10, face = "bold")
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))


```

```{r}
kelp_total <- kelp_data %>%
  group_by(ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE), 
    se_count = sd(count, na.rm = TRUE)/ sqrt(n()),
    .groups = "drop"
  )

kelp_total <- kelp_total %>%
  group_by(ARKEV_type) %>%
  mutate(
    percent_count = (mean_count / sum(mean_count)) * 100
  ) %>%
  ungroup()

```

```{r}
library(ggplot2)

ggplot(kelp_total, aes(x = ARKEV_type, y = percent_count, fill = species_code)) +
  geom_col(color = "black") +
  labs(
    title = "Overall Relative Kelp Species Composition by ARKEV Type",
    x = "ARKEV Type",
    y = "Percent of Total Kelp (%)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))


ggplot(kelp_total, aes(x = ARKEV_type, y = mean_count, fill = species_code)) +
  geom_col(position = "stack", color = "black") +
  labs(
    title = "Mean Kelp Species Abundance by ARKEV Type",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per mÂ²)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  )

```

```{r}
kelp_data_clean <- kelp_data %>%
  filter(!species_code %in% c("NO_KELP", "STUMP"))

kelp_richness <- kelp_data_clean %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    richness = n_distinct(species_code[!is.na(count) & count > 0]),
    .groups = "drop"
  )

kelp_abundance <- kelp_data_clean %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_abundance = mean(count, na.rm = TRUE),
    .groups = "drop"
  )
```

#kelp richness
```{r}
# Check normality
shapiro.test(kelp_richness$richness[kelp_richness$ARKEV_type == "ARKEV"])
shapiro.test(kelp_richness$richness[kelp_richness$ARKEV_type == "ARKEV_control"])

# Compare richness
t.test(richness ~ ARKEV_type, data = kelp_richness, var.equal = TRUE)
# or, if non-normal:
wilcox.test(richness ~ ARKEV_type, data = kelp_richness)
```

#kelp abundance
```{r}
# Check normality
shapiro.test(kelp_abundance$mean_abundance[kelp_abundance$ARKEV_type == "ARKEV"])
shapiro.test(kelp_abundance$mean_abundance[kelp_abundance$ARKEV_type == "ARKEV_control"])

# Compare abundance
t.test(mean_abundance ~ ARKEV_type, data = kelp_abundance, var.equal = TRUE)
# or nonparametric:
wilcox.test(mean_abundance ~ ARKEV_type, data = kelp_abundance)
```

#nereo recruits
```{r}
nereo <- kelp_data %>%
  filter(species_code %in% c("NERJ", "NERA", "LAMR"))

str(nereo)

nereo_summary <- nereo %>%
  group_by(Date, ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )
```

```{r}
nereo_aov <- aov(mean_count ~ ARKEV_type * species_code, data = nereo_summary)
summary(nereo_aov)
```

```{r}
TukeyHSD(nereo_aov)
```

```{r}
# NERJ
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "NERJ"))

# NERA
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "NERA"))

# LAMR
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "LAMR"))
```

```{r}
library(ggplot2)
kelp_means <- nereo %>%
  filter(species_code %in% c("NERA", "NERJ", "LAMR")) %>%
  group_by(ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

ggplot(kelp_means, aes(x = ARKEV_type, y = mean_count, fill = species_code)) +
  geom_col(position = position_dodge(width = 0.9), color = "black") +
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  labs(
    title = "Bull Kelp Abundance Across ARKEV Types",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per mÂ²)",
    fill = "Species"
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12)
  )

ggplot(nereo_summary, aes(x = Date, y = mean_count, color = species_code, linetype = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))
```


#blade number and reproductivity
```{r}

library(purrr)
#big river
br_kelp_MASTER = read_sheet('https://docs.google.com/spreadsheets/d/1mLYdDFh0XjEMPe9db5vKZzQMHRzRLlC-7fostoIXkM0/edit?gid=0#gid=0')

glimpse(br_kelp_MASTER)

# Helper function: safely convert list elements to numeric
to_numeric <- function(x) {
  map_dbl(x, ~ {
    # empty list â†’ NA
    if (length(.x) == 0) return(NA_real_)
    
    # if it's character, convert "NA" â†’ NA first
    if (is.character(.x)) {
      .x <- na_if(.x, "NA")
    }
    as.numeric(.x)
  })
}

br_kelp <- br_kelp_MASTER %>%
  mutate(
    site = "Big River",
    kelp_on_ARKEV = to_numeric(kelp_on_ARKEV),
    stipe_length = to_numeric(stipe_length),
    reproductive_kelp_on_ARKEV = to_numeric(reproductive_kelp_on_ARKEV),
    blade_number = to_numeric(blade_number),
    reproductive_blade_number = to_numeric(reproductive_blade_number)
  ) %>%
  filter(!is.na(kelp_on_ARKEV))

(br_kelp)

br_clean <- br_kelp %>%
  mutate(date = as.Date(paste(year, month, day, sep = "-"), format = "%Y-%m-%d"))%>%
  distinct(site, date, ARKEV_unit, .keep_all = TRUE) %>%
  group_by(site, date) %>%
  mutate(total = sum(kelp_on_ARKEV)) %>%
  select (-c(observer:...17))
print(br_clean)
```

```{r}
library(dplyr)
library(lubridate)

br_monthly_indiv <- br_clean %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  filter(!is.na(blade_number) & !is.na(reproductive_blade_number))%>%
  group_by(site, month, ARKEV_unit) %>%
  summarise(
    mean_blade_number = mean(blade_number, na.rm = TRUE),
    mean_repro_blades = mean(reproductive_blade_number, na.rm = TRUE),
    percent_fertile = ifelse(mean_blade_number > 0,
                             (mean_repro_blades / mean_blade_number) * 100, NA),
    .groups = "drop"
  ) %>%
  mutate(mean_spores_hr1 = 456111.1,
         se_spores_hr1 = 143536.1,
         mean_spores_hr2 = 450277.8,
         se_spores_hr2 = 108371.3,
         reproductive_output = mean_repro_blades * (mean_spores_hr1/3))

```

```{r}
br_monthly_total <- br_clean %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  filter(!is.na(blade_number) & !is.na(reproductive_blade_number))%>%
group_by(month) %>%
  summarise(
       total = mean(total),
       mean_blade_number = mean(blade_number, na.rm = TRUE),
       mean_repro_blades = mean(reproductive_blade_number, na.rm = TRUE),
       percent_fertile = ifelse(mean_blade_number > 0,
                             (mean_repro_blades / mean_blade_number) * 100, NA),
       total_repro_blades = mean_repro_blades * total,
       estimated_sori_released_4day = mean(reproductive_blade_number, na.rm = TRUE) * 7.5,
       estimated_sori_released_6day = mean(reproductive_blade_number, na.rm = TRUE) * 5,
    .groups = "drop"
  )%>%
  mutate(mean_spores_hr1 = 456111.1,
         se_spores_hr1 = 143536.1,
         mean_spores_hr2 = 450277.8,
         se_spores_hr2 = 108371.3,
         reproductive_output_4day = estimated_sori_released_4day * (mean_spores_hr1/3),
         reproductive_output_6day = estimated_sori_released_6day * (mean_spores_hr1/3))

# Transpose the data frame
br_mt_transposed <- as.data.frame(t(br_monthly_total))

write.csv(br_mt_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_mt_transposed.csv", 
          row.names = TRUE)

```

```{r}
br_repro_total <- br_monthly_total %>%
  summarise(
    mean_blade_number = mean(mean_blade_number, na.rm = TRUE),
    mean_repro_blades = mean(mean_repro_blades, na.rm = TRUE),
    percent_fertile = mean(percent_fertile),
    total_repro_blades = mean(total_repro_blades),
    mean_sori_4day = mean(estimated_sori_released_4day, na.rm = TRUE),
    se_sori_4day = sd(estimated_sori_released_4day, na.rm = TRUE) / sqrt(n()),
    mean_sori_6day = mean(estimated_sori_released_6day, na.rm = TRUE),
    se_sori_6day = sd(estimated_sori_released_6day, na.rm = TRUE) / sqrt(n()),
    mean_spores_4day = mean(reproductive_output_4day, na.rm = TRUE),
    se_spores_4day = sd(reproductive_output_4day, na.rm = TRUE) / sqrt(n()),
    mean_spores_6day = mean(reproductive_output_6day, na.rm = TRUE),
    se_spores_6day = sd(reproductive_output_6day, na.rm = TRUE) / sqrt(n())
  )

# Transpose the data frame
br_repro_transposed <- as.data.frame(t(br_repro_total))

write.csv(br_repro_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_repro_transposed.csv", 
          row.names = TRUE)
```

```{r}
br_estimate <- br_monthly_total %>%
  summarise(
    mean_sori_4day_total = mean(estimated_sori_released_4day, na.rm = TRUE) * 22.75,
    se_sori_4day_total = sd(estimated_sori_released_4day, na.rm = TRUE) / sqrt(n()) * 22.75,
    
    mean_sori_6day_total = mean(estimated_sori_released_6day, na.rm = TRUE) * 15,
    se_sori_6day_total = sd(estimated_sori_released_6day, na.rm = TRUE) / sqrt(n()) * 15,
    
    mean_spores_4day_total = mean(reproductive_output_4day, na.rm = TRUE) * 22.75,
    se_spores_4day_total = sd(reproductive_output_4day, na.rm = TRUE) / sqrt(n()) * 22.75,
    
    mean_spores_6day_total = mean(reproductive_output_6day, na.rm = TRUE) * 15,
    se_spores_6day_total = sd(reproductive_output_6day, na.rm = TRUE) / sqrt(n()) * 15
  )

br_estimate_transposed <- as.data.frame(t(br_estimate))

write.csv(br_estimate_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_estimate_transposed.csv", 
          row.names = TRUE)

```


#Kelp biomass data
```{r}
biomass = read_sheet("https://docs.google.com/spreadsheets/d/1heDRA0QEH3cwIhvrdjvF9p_Fdrphw9TvX3eAplhmBA8/edit?gid=0#gid=0")

biomass <- biomass %>%
  mutate(
    Stipe_length = as.numeric(Stipe_length),
    Weight = as.numeric(Weight),
    Total_blades = as.numeric(Total_Blades),
    Reproductive_blades = as.numeric(Reproductive_Blades)
  )
str(biomass)
```

```{r}
library(dplyr)

# Filter for Noyo site
noyo_data <- biomass %>%
  filter(Site == "Noyo")

# Summarize total biomass and mean Â± SE
noyo_biomass <- noyo_data %>%
  summarise(
    total_biomass = sum(Weight, na.rm = TRUE),          # total biomass (g)
    mean_biomass = mean(Weight, na.rm = TRUE),         # mean biomass per individual
    se_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))  # standard error
  )

noyo_arkev_biomass <- noyo_data %>%
  group_by(Unit)%>%
  summarize(
    total_biomass = sum(Weight, na.rm = TRUE),
    mean_biomass = mean(Weight, na.rm = TRUE),        
    se_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))  
  )

noyo_per_unit_summary <- noyo_arkev_biomass %>%
  summarise(
    mean_unit_biomass = mean(total_biomass, na.rm = TRUE),
    se_unit_biomass = sd(total_biomass, na.rm = TRUE) / sqrt(sum(!is.na(total_biomass)))
  )

```

```{r}
# Filter Big River data
br_biomass <- biomass %>%
  filter(Site == "Big River")

#Per ARKEV unit biomass
br_per_unit <- br_biomass %>%
  group_by(Unit) %>%
  summarise(
    unit_biomass = sum(Weight, na.rm = TRUE)
  )

br_per_unit_summary <- br_per_unit %>%
  summarise(
    mean_unit_biomass = mean(unit_biomass, na.rm = TRUE),
    se_unit_biomass = sd(unit_biomass, na.rm = TRUE) / sqrt(sum(!is.na(unit_biomass)))
  )


#Per individual kelp biomass
br_per_kelp_summary <- br_biomass %>%
  summarise(
    mean_kelp_biomass = mean(Weight, na.rm = TRUE),
    se_kelp_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))
  )

br_total_df <- br_clean %>%
  distinct(date, .keep_all = TRUE) %>%
  select(date, total)

str(br_total_df)

#Estimate total biomass for Big River using mean per kelp * total kelp count
br_final_biomass <- br_per_kelp_summary$mean_kelp_biomass * 179
br_arkev_final <- br_per_unit_summary$mean_unit_biomass * 44


```

```{r}
library(dplyr)
library(ggplot2)

# Add a Site column to each summary
noyo_plot_data <- noyo_per_unit_summary %>%
  mutate(Site = "Noyo")

br_plot_data <- br_per_unit_summary %>%
  mutate(Site = "Big River")

# Combine both
combined_plot_data <- bind_rows(noyo_plot_data, br_plot_data)

# Make bar plot with SE
ggplot(combined_plot_data, aes(x = Site, y = mean_unit_biomass, fill = Site)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_errorbar(aes(ymin = mean_unit_biomass - se_unit_biomass,
                    ymax = mean_unit_biomass + se_unit_biomass),
                width = 0.2) +
  labs(y = "Mean ARKEV Unit Biomass (kg)", x = "",
       title = "ARKEV Kelp Biomass by Site") +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.position = "none")
```

#Urchin size class data
```{r}
urch_data <- doc_MASTER %>%
  filter(data_type == "urchins") %>%
  dplyr::select(c(Date, month, ARKEV_type, ARKEV_unit, data_type, species_code, count, urch_size_class, substrate, depth_ft, temp_f, visibility_m)) %>%
  mutate(density = count/pi) 

#just purps
purps_data <- urch_data %>%
  filter(species_code == "STRPUR") %>% # only purps
filter(!(month == 10 & ARKEV_type == "ARKEV" & urch_size_class == "NA"), 
       !(month == 8 & ARKEV_type == "ARKEV" & count == "NA"))

purps_summary <- purps_data %>%
 group_by(month, ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))
```

##ARKEV vs. Control over time 
```{r}
purps_summary <- purps_summary %>%
  mutate(month = factor(month, levels = 4:10, labels = c("Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct")))



ggplot(
  purps_summary,
  aes(
    x = month,
    y = mean_density,
    color = urch_size_class,
    linetype = ARKEV_type,
    group = interaction(ARKEV_type, urch_size_class)
  )
) +
  geom_line(linewidth = 1.5) +
  geom_errorbar(
    aes(ymin = mean_density - sd_density,
        ymax = mean_density + sd_density),
    width = 0.1,      # small horizontal width for visual clarity
    size = 0.8) +
  scale_linetype_manual(values = c("ARKEV" = "solid", "ARKEV_control" = "dotted")) +
  scale_color_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Month",
    y = "Purple urchin density (indv/mÂ²)",
    color = "Size class",
    linetype = "Treatment"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    axis.text = element_text(color = "black"),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 12),
    axis.line = element_line(size = 0.4),
    panel.grid = element_blank()
  )

```

#stats (LLM)
```{r}


#checking distrubution of density data
ggplot(purps_data, aes(x = density)) +
  geom_histogram(aes(y = ..density..), bins = 30, alpha = 0.5) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of Urchin Density",
       x = "Urchin density (indv/mÂ²)",
       y = "Density") +
  theme_classic()

ggplot(purps_data, aes(sample = density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()

shapiro.test(purps_data$density) #NOT NORMALLY DISTRIBUTED

#log transformation
purps_data_log <- purps_data %>%
  mutate(log_density = log(density + 1))

shapiro.test(purps_data_log$log_density)
ggplot(purps_data_log, aes(sample = log_density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()


library(lme4)
library(lmerTest)

purps_data_log <- purps_data_log %>%
  mutate(month_f = factor(month))

#Model
full_mod <- lmer(
  log_density ~ month_f * ARKEV_type * urch_size_class + (1 | ARKEV_unit),
  data = purps_data_log
)

summary(full_mod)
  #
anova(full_mod)

library(emmeans)

# Get model predictions

emm_effects <- emmeans(full_mod,~ ARKEV_type | month_f * urch_size_class)

# ARKEV vs control difference at each month Ã— size class:
treat_diff <- contrast(emm_effects, method = "revpairwise")  # control - ARKEV or vice versa
treat_diff

```
##ARKEV vs. Control 
```{r}
purp_by_type <- purps_data %>%
  group_by(ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))

ggplot(
  purp_by_type,
  aes(x = urch_size_class, y = mean_density, fill = ARKEV_type)
) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c(
    "ARKEV_control" = "#1b9e77",
    "ARKEV"         = "#d95f02"
  )) +
  labs(
    x = "Size Class",
    y = "Purple urchin density (indv/mÂ²)",
    fill = "Treatment"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )

```
#stats(ART ANOVA)
```{r}
#checking distrubution of density data
ggplot(purps_data, aes(x = density)) +
  geom_histogram(aes(y = ..density..), bins = 30, alpha = 0.5) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of Urchin Density",
       x = "Urchin density (indv/mÂ²)",
       y = "Density") +
  theme_classic()

ggplot(purps_data, aes(sample = density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()

shapiro.test(purps_data$density) #NOT NORMALLY DISTRIBUTED

#log transformation
purps_data_log <- purps_data %>%
  mutate(log_density = log(density + 1))

shapiro.test(purps_data_log$log_density) #STILL NOT NORMALLY DISTRIBUTED
ggplot(purps_data_log, aes(sample = log_density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()

#testing model residuals for normality
model <- aov(log_density ~ ARKEV_type * urch_size_class, data = purps_data_log)
shapiro.test(residuals(model))
qqnorm(residuals(model))
qqline(residuals(model))
hist(residuals(model))
library(car)
leveneTest(log_density ~ ARKEV_type * urch_size_class, data = purps_data_log) #data does not meet two-way ANOVA assumptions 

#convert to factors
purps_data$ARKEV_type <- factor(purps_data$ARKEV_type)
purps_data$urch_size_class <- factor(purps_data$urch_size_class)


#using a non-parametric Aligned Rank Transformation ANOVA, on original data no need to log transform
library(ARTool)
model_art <- art(density ~ ARKEV_type * urch_size_class, data = purps_data)
anova(model_art) #urch_size_class p < 2e-16


# Main effects
art.con(model_art, "ARKEV_type")
art.con(model_art, "urch_size_class")

# Interaction-specific contrasts (if needed)
art.con(model_art, "ARKEV_type:urch_size_class")


ggplot(purps_data, aes(x = urch_size_class, y = density, fill = ARKEV_type)) +
  geom_boxplot(position = position_dodge()) +
  theme_classic() +
  labs(title = "Interaction of ARKEV Type and Urchin Size Class",
       x = "Urchin size class", y = "Density") +
  scale_fill_brewer(palette = "Set2")

```


#ARKEV vs. Control vs. ARKEV w/ drift
```{r}
#creating a df with three treatment types 
treatments <- purps_data %>%
  mutate(
    ARKEV_type = case_when(
      ARKEV_unit %in% c("2A", "2C", "2E", "2D", "2B",
                        "3A", "3C", "3E", "3B", "3D",
                        "5A", "5C", "5E", "5B", "5D", 
                        "6A", "6C", "6E", "6D", "6B",
                        "7A", "7C", "7E", "7B", "7D") ~ "ARKEV_drift",
      TRUE ~ ARKEV_type)) # keep existing values for all other units

treatment_density <- treatments %>%
  group_by(ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))

ggplot(treatment_density, aes(x = ARKEV_type, y = mean_density, fill = urch_size_class)) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Treatment",
    y = "Purple urchin density (indv/mÂ²)",
    fill = "Size class"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )
```
#stats(AOV)
```{r}
#data is not normally distributed even after log transforming so I am going to do a non-parametric ART ANOVA again

#convert to factors
treatments$ARKEV_type <- factor(treatments$ARKEV_type)
treatments$urch_size_class <- factor(treatments$urch_size_class)


#using a non-parametric Aligned Rank Transformation ANOVA, on original data no need to log transform
library(ARTool)
model_art <- art(density ~ ARKEV_type * urch_size_class, data = treatments)
anova(model_art) #urch_size_class p < 2e-16


# Main effects
art.con(model_art, "ARKEV_type")
art.con(model_art, "urch_size_class")

# Interaction-specific contrasts (if needed)
art.con(model_art, "ARKEV_type:urch_size_class")



```
#Urchin size class for Grazer Assays
```{r}
GA_size_class <- purps_data %>%
  mutate(
    ARKEV_type = case_when(
      ARKEV_unit %in% c(
        "2A", "2C", "2E", "2D", "2B",
        "3A", "3C", "3E", "3B", "3D",
        "5A", "5C", "5E", "5B", "5D",
        "6A", "6C", "6E", "6D", "6B",
        "7A", "7C", "7E", "7B", "7D"
      ) ~ "ARKEV_drift",
      
      ARKEV_unit %in% c(
        "C2A", "C2C", "C2E", "C2D", "C2B",
        "C7A", "C7C", "C7E", "C7B", "C7D",
        "C3A", "C3C", "C3E", "C3B", "C3D",
        "C9A", "C9C", "C9E", "C9B", "C9D",
        "C10A", "C10C", "C10E", "C10B", "C10D"
      ) ~ "ARKEV_control_GA",
      
      TRUE ~ ARKEV_type)) %>%
 filter(ARKEV_type != "ARKEV_control")%>%
  filter(month %in% c("7", "8", "9"))%>%
  mutate(month = factor(month, levels = c("7", "8", "9")))

View(GA_size_class)

GA_density <- GA_size_class %>%
  group_by(month,ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))



ggplot(GA_density, aes(x = ARKEV_type, y = mean_density, fill = urch_size_class)) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Treatment",
    y = "Purple urchin density (indv/mÂ²)",
    fill = "Size class"
  ) +
  facet_wrap(~ month) +   # <- add this line
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )+ theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


GA_density_total <- GA_size_class %>%
  group_by(ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))



ggplot(GA_density_total, aes(x = ARKEV_type, y = mean_density, fill = urch_size_class)) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Treatment",
    y = "Purple urchin density (indv/mÂ²)",
    fill = "Size class"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )+ theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```


#Benthic community data (BR)
```{r}
benthic_data <- doc_MASTER %>%
  filter(data_type %in% c("urchins", "kelp", "inverts", "tegula")) %>%
  dplyr::select(Date, month, ARKEV_type, ARKEV_unit, data_type,
                species_code, count, urch_size_class, substrate,
                depth_ft, temp_f, visibility_m) %>%
  mutate(density = count / pi)


benthic_data_cleaned <- benthic_data %>%
   mutate( species_code = case_when(
      species_code == "STRPUR" & urch_size_class == "<2cm" ~ "STRPUR_<2cm",
      species_code == "STRPUR" & urch_size_class == ">2cm" ~ "STRPUR_>2cm",
      TRUE ~ species_code
    ) 
  ) %>%
  filter(!(month == 10 & ARKEV_type == "ARKEV" & urch_size_class == "NA"), 
       !(month == 8 & ARKEV_type == "ARKEV" & count == "NA"), 
       !(month == 7 & ARKEV_type == "ARKEV_control" & ARKEV_unit == "C7A" & count == "NA")) %>%
  dplyr::select(-c(urch_size_class:visibility_m))

#Cleaning up matrix (NO KELP/INVERT)

library(dplyr)
library(tidyr)

benthic_comm_balance <- benthic_data_cleaned %>%
  filter(data_type %in% c("urchins", "kelp", "inverts", "tegula")) %>%
  mutate(
    count   = tidyr::replace_na(count, 0),
    density = tidyr::replace_na(density, 0)
  ) %>%
  group_by(Date, month, ARKEV_type, ARKEV_unit, species_code) %>%  # ðŸ”´ KEY STEP
  summarise(
    density = sum(density, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = species_code,
    values_from = density,
    values_fill = 0
  ) %>%
  # drop the pseudo-species columns, KEEP the rows
  select(-any_of(c("NO_INVERTS", "NO_KELP")))


anyNA(benthic_comm_balance)
```

##ARKEV blocks
```{r}
library(vegan)
library(stringr)

benthic_block <- benthic_comm_balance %>%
  mutate(
    # remove leading "C" if present (e.g. "C10A" -> "10A")
    clean_unit = str_remove(ARKEV_unit, "^C"),
    # extract the block number (digits before the first letter)
    block      = str_extract(clean_unit, "^\\d+")
  ) %>%
  filter(month != 10) %>%
  group_by(month, ARKEV_type, block) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )


#building community matrix and meta data matrix
meta_block <- benthic_block %>%
  dplyr::select(month,ARKEV_type, block)

comm_block <- benthic_block %>%
  dplyr::select(-ARKEV_type, -block, -month)

#checking to see if there are any rows with sum of zero
row_sums <- rowSums(comm_block)
non_empty <- row_sums > 0
sum(row_sums == 0)

#nmds
set.seed(123)
nmds_block <- metaMDS(comm_block, distance = "bray", k = 2)

#permanova
adonis2(comm_block ~ ARKEV_type + month, data = meta_block, method = "bray")

#envfit
fit_block <- envfit(nmds_block, comm_block, permutations = 999)

# look at results
fit_block

#plot
site_scores <- as.data.frame(scores(nmds_block, display = "sites")) %>%
  bind_cols(meta_block)

ggplot(site_scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = factor(month), shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.15,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual( values = c( "4" = "#ffffb2", "5" = "#fed976", "6" = "#feb24c", "7" = "#fd8d3c", "8" = "#f03b20", "9" = "#bd0026")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )


```
###per month
```{r}
library(purrr)
library(dplyr)
library(tibble)
library(pairwiseAdonis)
library(vegan)
library(tidyr)
library(ggplot2)
library(grid)

# make sure month is treated as a factor
meta_block$month <- as.factor(meta_block$month)

#getting pairwise results for the permanova test
pairwise_results <- pairwise.adonis2(
  comm_block~ month,
  data        = meta_block,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "holm", "BH", etc.
)
pairwise_results

months <- unique(meta_block$month)
results <- lapply(months, function(m) {
idx <- meta_block$month == m

adonis2(comm_block[idx, ] ~ ARKEV_type,
    data = meta_block[idx, ],
    method = "bray")})

names(results) <- paste0("Month_", months)
results

#in months 7 and 9, community composition is significantly different between treatment types 

#creating a df of significant p values from permanova test
perma_df <- map2_dfr(results, months, function(res, m) {
  tibble(
    month   = as.factor(m),
    p_ARKEV = res$`Pr(>F)`[1]   # first row = ARKEV_type
  )
})

perma_df

#significant months
sig_months <- perma_df %>%
  filter(p_ARKEV < 0.05) %>%
  pull(month)

#annoting p-values inside the plot
x_pos <- max(site_scores$NMDS1) * 0.9
y_pos <- max(site_scores$NMDS2) * 0.9

annot_df <- perma_df %>%
  filter(month %in% sig_months) %>%
  mutate(
    label = paste0("p = ", signif(p_ARKEV, 2)),
    NMDS1 = x_pos,
    NMDS2 = y_pos
  )

ggplot(site_scores, aes(x = NMDS1, y = NMDS2)) +
  # points
  geom_point(
    aes(color = ARKEV_type, shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  # ellipses by treatment
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.15
  ) +
  # PERMANOVA p-values ONLY in months 7 & 9
  geom_text(
    data        = annot_df,
    aes(x = NMDS1, y = NMDS2, label = label),
    inherit.aes = FALSE,
    hjust       = 1.0,
    vjust       = -1.0,
    size        = 3.5
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x     = "NMDS1",
    y     = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )

```


##ARKEV units
```{r}
library(vegan)
library(stringr)

benthic_comm_unit <- benthic_comm_balance %>%
    filter(month != 10) %>%
  group_by(ARKEV_type, ARKEV_unit) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )


# 1. Build meta and comm from the same benthic_comm
meta <- benthic_comm_unit %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm <- benthic_comm_unit %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)

row_sums <- rowSums(comm)
non_empty <- row_sums > 0
sum(row_sums == 0)

comm_ne <- comm[non_empty, ]
meta_ne <- meta[non_empty, ]


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm_ne, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_ne ~ ARKEV_type, data = meta_ne, method = "bray")
permanova

# 8. Plot NMDS
site_scores <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta_ne)


ggplot() +
  geom_point(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment"
  ) +
  scale_color_manual(values = c("ARKEV" = "blue", "ARKEV_control" = "red")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )

```

###per month
```{r}
benthic_comm_unit_month <- benthic_comm_balance %>%
    filter(month != 10) %>%
group_by(ARKEV_type, ARKEV_unit, month) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )


meta <- benthic_comm_unit_month %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm <- benthic_comm_unit_month %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)

row_sums <- rowSums(comm)
non_empty <- row_sums > 0
sum(row_sums == 0)

comm_ne <- comm[non_empty, ]
meta_ne <- meta[non_empty, ]


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm_ne, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_ne ~ ARKEV_type * month, data = meta_ne, method = "bray")
permanova

# 8. Plot NMDS
site_scores_2 <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta_ne)


ggplot(site_scores_2, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = factor(month), shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.15,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual( values = c( "4" = "#ffffb2", "5" = "#fed976", "6" = "#feb24c", "7" = "#fd8d3c", "8" = "#f03b20", "9" = "#bd0026"
    )
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )
```

```{r}
###per month
ggplot(site_scores_2, aes(x = NMDS1, y = NMDS2)) +
    scale_fill_manual(values = c(
    "ARKEV_control" = "#1b9e77",
    "ARKEV"         = "#d95f02"
  )) +
  geom_point(
    aes(color = ARKEV_type, shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.15
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )


library(pairwiseAdonis)

# make sure month is treated as a factor
meta_ne$month <- as.factor(meta_ne$month)

pairwise_results <- pairwise.adonis2(
  comm_ne ~ month,
  data        = meta_ne,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "holm", "BH", etc.
)

pairwise_results

library(vegan)

months <- unique(meta_ne$month)
set.seed(123)
results <- lapply(months, function(m) {idx <- meta_ne$month == m

adonis2(

    comm_ne[idx, ] ~ ARKEV_type,
    data = meta_ne[idx, ],
    method = "bray")})

names(results) <- paste0("Month_", months)

results

#9
```

##ARKEV treatments 
```{r}
benthic_comm_treat <- benthic_comm_balance %>%
   filter(month != 10) %>%
  mutate(
    ARKEV_type = case_when(
      ARKEV_unit %in% c("2A", "2C", "2E", "2D", "2B",
                        "3A", "3C", "3E", "3B", "3D",
                        "5A", "5C", "5E", "5B", "5D", 
                        "6A", "6C", "6E", "6D", "6B",
                        "7A", "7C", "7E", "7B", "7D") ~ "ARKEV_drift",
      
      TRUE ~ ARKEV_type)) %>%
  group_by(ARKEV_type, ARKEV_unit) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )

meta <- benthic_comm_treat %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm <- benthic_comm_treat %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)


row_sums <- rowSums(comm)
non_empty <- row_sums > 0
sum(row_sums == 0)


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm ~ ARKEV_type, data = meta, method = "bray")
permanova

# 8. Plot NMDS
site_scores_3 <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta)


ggplot() +
  geom_point(
    data = site_scores_3,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 1,
    show.legend = FALSE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment"
  ) +
  scale_color_manual(values = c("ARKEV" = "#a6cee3", "ARKEV_control" = "#b2df8a", "ARKEV_drift" = "#1f78b4")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )

```
###per month
```{r}
benthic_comm_treat_month <- benthic_comm_balance %>%
   filter(month != 10) %>%
  mutate(
    ARKEV_type = case_when(
      ARKEV_unit %in% c("2A", "2C", "2E", "2D", "2B",
                        "3A", "3C", "3E", "3B", "3D",
                        "5A", "5C", "5E", "5B", "5D", 
                        "6A", "6C", "6E", "6D", "6B",
                        "7A", "7C", "7E", "7B", "7D") ~ "ARKEV_drift",
      
      TRUE ~ ARKEV_type)) %>%
  group_by(ARKEV_type, ARKEV_unit, month) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )

meta_month <- benthic_comm_treat_month %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_month <- benthic_comm_treat_month %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_month)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_ne <- comm_month[non_empty, ]
meta_ne <- meta_month[non_empty, ]


# 6. NMDS
set.seed(123)
nmds_month <- metaMDS(comm_ne, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
set.seed(123)
permanova <- adonis2(comm_ne ~ ARKEV_type, data = meta_ne, method = "bray")
permanova

# 8. Plot NMDS
site_scores_3 <- as.data.frame(scores(nmds_month, display = "sites")) %>%
  bind_cols(meta_ne)


ggplot(site_scores_3, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = ARKEV_type, shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.8
  ) +
    scale_color_manual(values = c("ARKEV" = "#a6cee3", "ARKEV_control" = "#b2df8a", "ARKEV_drift" = "#1f78b4")) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```

```{r}
# make sure month is treated as a factor
meta_ne$month <- as.factor(meta_ne$month)

pairwise_results <- pairwise.adonis2(
  comm_ne ~ month,
  data        = meta_ne,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "holm", "BH", etc.
)

pairwise_results

library(vegan)

months <- unique(meta_ne$month)
set.seed(123)
results <- lapply(months, function(m) {idx <- meta_ne$month == m

adonis2(

    comm_ne[idx, ] ~ ARKEV_type,
    data = meta_ne[idx, ],
    method = "bray")})

names(results) <- paste0("Month_", months)

results
```
####envfit model for significant months
```{r}
month_5 <- benthic_comm_treat_month %>%
  filter(month == "5")


meta_month_5 <- month_5 %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm_month_5 <- month_5 %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)


row_sums <- rowSums(comm_month_5)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_ne_5 <- comm_month_5[non_empty, ]
meta_ne_5 <- meta_month_5[non_empty, ]


# 6. NMDS
set.seed(123)
nmds_month_5 <- metaMDS(comm_ne_5, distance = "bray", k = 2)

#getting species vectors 
species_fit <- envfit(nmds_month_5, comm_ne_5, permutations = 999)

scores_sites <- as.data.frame(scores(nmds_month_5, display = "sites"))
scores_sites <- cbind(scores_sites, meta_ne_5)

scores_species <- as.data.frame(scores(species_fit, display = "vectors"))
scores_species$species <- rownames(scores_species)
scores_species$pval <- species_fit$vectors$pvals

sig_species <- scores_species %>%
  dplyr::arrange(pval) %>%
  dplyr::slice(1:10)



library(ggplot2)
library(ggrepel)

ggplot(scores_sites, aes(x = NMDS1, y = NMDS2, color = ARKEV_type)) +
  geom_point(size = 3) +
  stat_ellipse(aes(group = ARKEV_type), level = 0.95) +
geom_segment(
    data = sig_species,
    inherit.aes = FALSE,
    aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black"
  ) +
  geom_text_repel(
    data = sig_species,
    inherit.aes = FALSE,
    aes(x = NMDS1, y = NMDS2, label = species),
    size = 3,
    color = "black"
  ) +
  theme_classic() +
  labs(
    title = "NMDS â€“ Month 5",
    color = "ARKEV type"
  ) +
  scale_color_manual(
    values = c(
      "ARKEV"         = "#a6cee3",
      "ARKEV_control" = "#b2df8a",
      "ARKEV_drift"   = "#1f78b4"
    )
  )

```
```{r}
month_9 <- benthic_comm_treat_month %>%
  filter(month == 9)

meta_month_9 <- month_9 %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm_month_9 <- month_9 %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)

row_sums_9 <- rowSums(comm_month_9)
non_empty_9 <- row_sums_9 > 0
comm_ne_9 <- comm_month_9[non_empty_9, ]
meta_ne_9 <- meta_month_9[non_empty_9, ]

set.seed(123)
nmds_month_9 <- metaMDS(comm_ne_9, distance = "bray", k = 2)

species_fit_9 <- envfit(nmds_month_9, comm_ne_9, permutations = 999)

scores_sites_9 <- as.data.frame(scores(nmds_month_9, display = "sites"))
scores_sites_9 <- cbind(scores_sites_9, meta_ne_9)

scores_species_9 <- as.data.frame(scores(species_fit_9, display = "vectors"))
scores_species_9$species <- rownames(scores_species_9)
scores_species_9$pval <- species_fit_9$vectors$pvals


sig_species_9 <- scores_species_9 %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::arrange(pval) %>%
  dplyr::slice(1:10)


library(ggplot2)
library(ggrepel)

ggplot(scores_sites_9, aes(x = NMDS1, y = NMDS2, color = ARKEV_type)) +
  geom_point(size = 3) +
  stat_ellipse(aes(group = ARKEV_type), level = 0.95) +
  geom_segment(
    data = sig_species_9,
    inherit.aes = FALSE,
    aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black"
  ) +
  geom_text_repel(
    data = sig_species_9,
    inherit.aes = FALSE,
    aes(x = NMDS1, y = NMDS2, label = species),
    size = 3,
    color = "black"
  ) +
  theme_classic() +
  labs(
    title = "NMDS â€“ Month 9",
    color = "ARKEV type"
  ) +
  scale_color_manual(
    values = c(
      "ARKEV"         = "#a6cee3",
      "ARKEV_control" = "#b2df8a",
      "ARKEV_drift"   = "#1f78b4"
    )
  )

```

##ARKEV quadrants
```{r}
benthic_comm_quad <- benthic_comm_balance %>%
   filter(month != 10) %>%
 mutate(ARKEV_type = case_when(
      ARKEV_unit %in% c("C1D", "C1B", "C1A", "C1C", "C1E", "2A", "2C", "2E", "2D", "2B", "C3D", "C3B", "C3A", "C3C", "C3E", "4E", "4C", "4A", "4D", "4B" ,"C5D", "C5B", "C5A", "C5C", "C5E") ~ "ARKEV_NW",
      ARKEV_unit %in% c("1A", "1C", "1E", "1B", "1D" , "C2D", "C2B", "C2A", "C2C", "C2E", "3A", "3C", "3E", "3B", "3D", "C4D", "C4B", "C4A", "C4C", "C4E", "5A", "5C", "5E", "5B", "5D") ~ "ARKEV_SW",
      ARKEV_unit %in% c("6A", "6C", "6E", "6B", "6D" , "C7D", "C7B", "C7A", "C7C", "C7E", "8A", "8C", "8E", "8B", "8D", "C9D", "C9B", "C9A", "C9C", "C9E", "10A", "10C", "10E", "10B", "10D") ~ "ARKEV_NE", 
      ARKEV_unit %in% c("C6D", "C6B", "C6A", "C6C", "C6E", "7A", "7C", "7E", "7D", "7B", "C8D", "C8B", "C8A", "C8C", "C8E", "9E", "9C", "9A", "9D", "9B" ,"C10D", "C10B", "C10A", "C10C", "C10E") ~ "ARKEV_SE")) %>%
  group_by(ARKEV_type, ARKEV_unit) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )

meta_q <- benthic_comm_quad %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm_q <- benthic_comm_quad %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)


row_sums <- rowSums(comm_q)
non_empty <- row_sums > 0
sum(row_sums == 0)


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm_q, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_q ~ ARKEV_type, data = meta_q, method = "bray")
permanova

pairwise_results <- pairwise.adonis2(
  comm_q ~ ARKEV_type,
  data        = meta_q,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "holm", "BH", etc.
)

pairwise_results

# 8. Plot NMDS
site_scores_4 <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta_q)


ggplot() +
  geom_point(
    data = site_scores_4,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment"
  ) +
  scale_color_manual(values = c("ARKEV_NW" = "#d7191c", "ARKEV_SW" = "#fdae61", "ARKEV_NE" = "#abd9e9", "ARKEV_SE" = "#2c7bb6")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )
```


###per month
```{r}
benthic_comm_quad_month <- benthic_comm_balance %>%
   filter(month != 10) %>%
 mutate(ARKEV_type = case_when(
      ARKEV_unit %in% c("C1D", "C1B", "C1A", "C1C", "C1E", "2A", "2C", "2E", "2D", "2B", "C3D", "C3B", "C3A", "C3C", "C3E", "4E", "4C", "4A", "4D", "4B" ,"C5D", "C5B", "C5A", "C5C", "C5E") ~ "ARKEV_NW",
      ARKEV_unit %in% c("1A", "1C", "1E", "1B", "1D" , "C2D", "C2B", "C2A", "C2C", "C2E", "3A", "3C", "3E", "3B", "3D", "C4D", "C4B", "C4A", "C4C", "C4E", "5A", "5C", "5E", "5B", "5D") ~ "ARKEV_SW",
      ARKEV_unit %in% c("6A", "6C", "6E", "6B", "6D" , "C7D", "C7B", "C7A", "C7C", "C7E", "8A", "8C", "8E", "8B", "8D", "C9D", "C9B", "C9A", "C9C", "C9E", "10A", "10C", "10E", "10B", "10D") ~ "ARKEV_NE", 
      ARKEV_unit %in% c("C6D", "C6B", "C6A", "C6C", "C6E", "7A", "7C", "7E", "7D", "7B", "C8D", "C8B", "C8A", "C8C", "C8E", "9E", "9C", "9A", "9D", "9B" ,"C10D", "C10B", "C10A", "C10C", "C10E") ~ "ARKEV_SE")) %>%
  group_by(ARKEV_type, ARKEV_unit, month) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )

meta_qm <- benthic_comm_quad_month %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_qm <- benthic_comm_quad_month %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_qm)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_ne <- comm_qm[non_empty, ]
meta_ne <- meta_qm[non_empty, ]

# 6. NMDS
set.seed(123)
nmds_res_qm <- metaMDS(comm_ne, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_ne ~ ARKEV_type, data = meta_ne, method = "bray")
permanova

# 8. Plot NMDS
site_scores_5 <- as.data.frame(scores(nmds_res_qm, display = "sites")) %>%
  bind_cols(meta_ne)


ggplot(site_scores_5, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = ARKEV_type, shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
    scale_color_manual(values = c("ARKEV_NW" = "#d7191c", "ARKEV_SW" = "#fdae61", "ARKEV_NE" = "#abd9e9", "ARKEV_SE" = "#2c7bb6")) +
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.7
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```
```{r}
# make sure month is treated as a factor
meta_ne$month <- as.factor(meta_ne$month)

pairwise_results <- pairwise.adonis2(
  comm_ne ~ month,
  data        = meta_ne,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "holm", "BH", etc.
)

pairwise_results

library(vegan)

months <- unique(meta_ne$month)
set.seed(123)
results <- lapply(months, function(m) {idx <- meta_ne$month == m

adonis2(

    comm_ne[idx, ] ~ ARKEV_type,
    data = meta_ne[idx, ],
    method = "bray")})

names(results) <- paste0("Month_", months)

results
```


####NE per month
```{r}
arkev_ne <- benthic_comm_quad_month %>%
  filter(ARKEV_type =="ARKEV_NE")

meta_NE <- arkev_ne %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_NE <- arkev_ne %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_NE)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_ne <- comm_NE[non_empty, ]
meta_ne <- meta_NE[non_empty, ]

# 6. NMDS
set.seed(123)
nmds_res_NE <- metaMDS(comm_ne, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
adonis2(comm_ne ~ month, data = meta_ne, method = "bray")

#posthoc
pairwise.adonis2(
  comm_ne ~ month,
  data        = meta_ne,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "BH"
)

# 8. Plot NMDS
site_scores_6 <- as.data.frame(scores(nmds_res_NE, display = "sites")) %>%
  bind_cols(meta_ne)


ggplot(site_scores_6, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = factor(month), shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.15,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#ffffcc",
      "5"  = "#c7e9b4",
      "6"  = "#7fcdbb",
      "7"  = "#41b6c4",
      "8"  = "#2c7fb8",
      "9"  = "#253494"
    )
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )

ggplot(site_scores_6, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
    aes(color = factor(month), shape = ARKEV_type),
    size  = 3.5,
    alpha = 0.85
  ) +
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.15
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#ffffcc",
      "5"  = "#c7e9b4",
      "6"  = "#7fcdbb",
      "7"  = "#41b6c4",
      "8"  = "#2c7fb8",
      "9"  = "#253494"
    )
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```
####SE per month
```{r}
arkev_se <- benthic_comm_quad_month %>%
  filter(ARKEV_type =="ARKEV_SE")

meta_SE <- arkev_se %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_SE <- arkev_se %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_SE)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_se <- comm_SE[non_empty, ]
meta_se <- meta_SE[non_empty, ]

# 6. NMDS
set.seed(123)
nmds_res_SE <- metaMDS(comm_se, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
adonis2(comm_se ~ month, data = meta_se, method = "bray")

#posthoc
pairwise.adonis2(
  comm_se ~ month,
  data        = meta_se,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "BH"
)
# 8. Plot NMDS
site_scores_7 <- as.data.frame(scores(nmds_res_SE, display = "sites")) %>%
  bind_cols(meta_se)


ggplot(site_scores_7, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
  aes(color = factor(month)),
  shape = 15,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.15,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#fef0d9",
      "5"  = "#fdd49e",
      "6"  = "#fdbb84",
      "7"  = "#fc8d59",
      "8"  = "#e34a33",
      "9"  = "#b30000"
    )
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )

ggplot(site_scores_7, aes(x = NMDS1, y = NMDS2)) +
 geom_point(
  aes(color = factor(month)),
  shape = 15,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.15
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#fef0d9",
      "5"  = "#fdd49e",
      "6"  = "#fdbb84",
      "7"  = "#fc8d59",
      "8"  = "#e34a33",
      "9"  = "#b30000"
    )
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```

####SW per month
```{r}
arkev_sw <- benthic_comm_quad_month %>%
  filter(ARKEV_type =="ARKEV_SW")

meta_SW <- arkev_sw %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_SW <- arkev_sw %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_SW)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_sw <- comm_SW[non_empty, ]
meta_sw <- meta_SW[non_empty, ]

# 6. NMDS
set.seed(123)
nmds_res_SW <- metaMDS(comm_sw, distance = "bray", k = 2)

#permanova
adonis2(comm_sw ~ month, data = meta_sw, method = "bray")

#posthoc
pairwise.adonis2(
  comm_sw ~ month,
  data        = meta_sw,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "BH"
)

# 8. Plot NMDS
site_scores_8 <- as.data.frame(scores(nmds_res_SW, display = "sites")) %>%
  bind_cols(meta_sw)


ggplot(site_scores_8, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
  aes(color = factor(month)),
  shape = 18,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.15,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#ffffd4",
      "5"  = "#fee391",
      "6"  = "#fec44f",
      "7"  = "#fe9929",
      "8"  = "#d95f0e",
      "9"  = "#993404"
    )
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )

ggplot(site_scores_7, aes(x = NMDS1, y = NMDS2)) +
 geom_point(
  aes(color = factor(month)),
  shape = 18,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.15
  ) +
    scale_color_manual(
    values = c(
      "4"  = "#ffffd4",
      "5"  = "#fee391",
      "6"  = "#fec44f",
      "7"  = "#fe9929",
      "8"  = "#d95f0e",
      "9"  = "#993404"
    )
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```
####NW per month
```{r}
arkev_nw <- benthic_comm_quad_month %>%
  filter(ARKEV_type =="ARKEV_NW")

meta_NW <- arkev_nw %>%
  dplyr::select(ARKEV_type, ARKEV_unit, month)

comm_NW <- arkev_nw %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit, -month)


row_sums <- rowSums(comm_NW)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_nw <- comm_NW[non_empty, ]
meta_nw <- meta_NW[non_empty, ]

# 6. NMDS
set.seed(123)
nmds_res_NW <- metaMDS(comm_nw, distance = "bray", k = 2)

#permanova
adonis2(comm_nw ~ month, data = meta_nw, method = "bray")

#posthoc
pairwise.adonis2(
  comm_nw ~ month,
  data        = meta_nw,
  sim.method  = "bray",
  p.adjust.m  = "bonferroni"   # or "BH"
)

# 8. Plot NMDS
site_scores_9 <- as.data.frame(scores(nmds_res_NW, display = "sites")) %>%
  bind_cols(meta_nw)


ggplot(site_scores_9, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
  aes(color = factor(month)),
  shape = 17,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = factor(month), linetype = ARKEV_type),
    type        = "t",
    size        = 0.8,
    alpha       = 0.7,
    show.legend = TRUE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x        = "NMDS1",
    y        = "NMDS2",
    color    = "Month",
    shape    = "Treatment",
    linetype = "Treatment"
  ) +
  scale_color_manual(
    values = c(
      "4"  = "#f1eef6",
      "5"  = "#d0d1e6",
      "6"  = "#a6bddb",
      "7"  = "#74a9cf",
      "8"  = "#2b8cbe",
      "9"  = "#045a8d"
    )
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position  = "right",
    legend.title     = element_text(face = "bold"),
    legend.key       = element_rect(fill = NA),
    legend.key.size  = unit(0.8, "cm"),
    plot.title       = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title       = element_text(face = "bold", size = 14),
    axis.text        = element_text(size = 12)
  )

ggplot(site_scores_9, aes(x = NMDS1, y = NMDS2)) +
  geom_point(
  aes(color = factor(month)),
  shape = 17,      # â† triangle
  size  = 3.5,
  alpha = 0.85
)+
  stat_ellipse(
    aes(color = ARKEV_type),
    type  = "t",
    size  = 0.8,
    alpha = 0.7
  ) +
 scale_color_manual(
    values = c(
      "4"  = "#f1eef6",
      "5"  = "#d0d1e6",
      "6"  = "#a6bddb",
      "7"  = "#74a9cf",
      "8"  = "#2b8cbe",
      "9"  = "#045a8d"
    )
  ) +
  facet_wrap(~ month) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment",
    shape = "Treatment"
  )
```

<<<<<<< HEAD
=======
#2024 vs 2025
```{r}
both_years = read_sheet('https://docs.google.com/spreadsheets/d/1Z6wg7j9N0Re7aYNvnVBlg4Tf-roa88E2YaVylnP74Z8/edit?gid=642331766#gid=642331766')

both_years

both_years_MASTER <- both_years %>%
# turn "NA" strings in character columns into real NA
  mutate(across(where(is.character), ~ na_if(.x, "NA"))) %>%
# list-columns that are truly numeric-ish
  mutate(
    count   = to_numeric(count),
    percent = to_numeric(percent)
  ) %>%
# handle size_cm specially
  mutate(
# keep the original category (<2cm, >2cm, numbers) as a character column "urchin_size_class"
    urch_size_class = map_chr(size_cm, ~ {
      if (length(.x) == 0) return(NA_character_)
      as.character(.x)
    }),
# numeric version: fish lengths only; urchin categories â†’ NA
    size_cm = map_dbl(size_cm, ~ {
      if (length(.x) == 0) return(NA_real_)
      if (is.character(.x)) {
# drop urchin categories from numeric column
        if (.x %in% c("<2cm", ">2cm")) return(NA_real_)
        .x <- na_if(.x, "NA")
      }
      as.numeric(.x)
    })
  ) %>%
  mutate(Date = make_date(year, month, day))


all_benthic_data <- both_years_MASTER %>%
  filter(data_type %in% c("urchins", "kelp", "inverts", "tegula")) %>%
  dplyr::select(year, Date, month, ARKEV_type, ARKEV_unit, data_type,
                species_code, count) %>%
  mutate(
    density = case_when(
      year == 2024 ~ count,          # already per mÂ²
      year == 2025 ~ count / pi,     # convert 1 m radius counts to per mÂ²
      TRUE ~ NA_real_
    )
  )


all_benthic_data_cleaned <- all_benthic_data %>%
  filter(!(month == 10 & ARKEV_type == "ARKEV"), 
       !(month == 8 & ARKEV_type == "ARKEV" & count == "NA"), 
       !(month == 7 & ARKEV_type == "ARKEV_control" & ARKEV_unit == "C7A" & count == "NA"))


all_benthic_comm_balance <- all_benthic_data_cleaned %>%
  filter(data_type %in% c("urchins", "kelp", "inverts", "tegula")) %>%
  mutate(
    count   = tidyr::replace_na(count, 0),
    density = tidyr::replace_na(density, 0)
  ) %>%
  group_by(year,Date, month, ARKEV_type, ARKEV_unit, species_code) %>%  # ðŸ”´ KEY STEP
  summarise(
    density = sum(density, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = species_code,
    values_from = density,
    values_fill = 0
  ) %>%
  # drop the pseudo-species columns, KEEP the rows
  select(-any_of(c("NO_INVERTS", "NO_KELP")))


anyNA(all_benthic_comm_balance)

```
##Overall community comp
```{r}
benthic_comm_year <- all_benthic_comm_balance %>%
  group_by(year, ARKEV_type, ARKEV_unit) %>%
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )


# 1. Build meta and comm from the same benthic_comm
meta_year <- benthic_comm_year %>%
  dplyr::select(year, ARKEV_type, ARKEV_unit)

comm_year <- benthic_comm_year %>%
  dplyr::select(-year, -ARKEV_type, -ARKEV_unit)

row_sums <- rowSums(comm_year)
non_empty <- row_sums > 0
sum(row_sums == 0)



# 6. NMDS
set.seed(123)
nmds_yr <- metaMDS(comm_year, distance = "bray", k = 2)

# 7. PERMANOVA (r2 = 0.088, p = 0.001)
adonis2(comm_year ~ year, data = meta_year, method = "bray")


# 8. Plot NMDS
site_scores <- as.data.frame(scores(nmds_yr, display = "sites")) %>%
  bind_cols(meta_year) %>%
  mutate(year = as.factor(year))



ggplot() +
  geom_point(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = year),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = year),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  theme_classic(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Year"
  ) +
  scale_color_manual(values = c("2024" = "darkblue", "2025" = "red3")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )
```
```{r}
# 1. Fit species vectors
species_fit <- envfit(nmds_yr, comm_year, permutations = 999)

# 2. Extract site scores and bind metadata (convert year to factor)
scores_sites <- as.data.frame(scores(nmds_yr, display = "sites")) %>%
  bind_cols(meta_year %>% mutate(year = as.factor(year)))   # <- key fix here

# 3. Extract species scores
scores_species <- as.data.frame(scores(species_fit, display = "vectors"))
scores_species$species <- rownames(scores_species)
scores_species$pval <- species_fit$vectors$pvals

# 4. Keep top 10 most significant species
sig_species <- scores_species %>%
  arrange(pval) %>%
  slice(1:10)

# 5. NMDS plot
ggplot(scores_sites, aes(x = NMDS1, y = NMDS2, color = year)) +
  geom_point(size = 3) +
  stat_ellipse(aes(group = year), level = 0.95) +
  geom_segment(
    data = sig_species,
    inherit.aes = FALSE,
    aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
    arrow = arrow(length = unit(0.4, "cm")),
    color = "black"
  ) +
geom_text_repel(
  data = sig_species,
  inherit.aes = FALSE,
  aes(x = NMDS1, y = NMDS2, label = species),
  size = 4.5,               # a little bigger
  color = "black",
  fontface = "bold",        # <- makes text bold
  segment.color = NA        # optional: removes label connector lines
)+
  theme_classic() +
  labs(
    title = "NMDS â€“ Yearly Comparison (2024 vs 2025)",
    color = "Year"
  ) +
  scale_color_manual(values = c("2024" = "darkblue", "2025" = "red3"))

```
##per month
```{r}
benthic_comm_time <- all_benthic_comm_balance %>%
  group_by(year, month, ARKEV_type, ARKEV_unit) %>%  # unit Ã— month Ã— year
  summarise(
    across(MESFRA:PARCAL, mean, na.rm = TRUE),
    .groups = "drop"
  )

meta_time <- benthic_comm_time %>%
  dplyr::select(year, month, ARKEV_type, ARKEV_unit)

comm_time <- benthic_comm_time %>%
  dplyr::select(MESFRA:PARCAL)

row_sums <- rowSums(comm_time)
non_empty <- row_sums > 0
sum(row_sums == 0)
comm_ne <- comm_time[non_empty, ]
meta_ne <- meta_time[non_empty, ]

set.seed(123)
nmds_time <- metaMDS(comm_ne, distance = "bray", k = 2)

site_scores_time <- as.data.frame(scores(nmds_time, display = "sites")) %>%
  bind_cols(meta_ne)
library(dplyr)

site_scores_time <- as.data.frame(scores(nmds_time, display = "sites")) %>%
  bind_cols(meta_time)

month_centroids <- site_scores_time %>%
  group_by(year, month) %>%
  summarise(
    NMDS1 = mean(NMDS1),
    NMDS2 = mean(NMDS2),
    .groups = "drop"
  ) %>%
  arrange(year, month) %>%
  mutate(
    year = as.factor(year),
    # label like "Apr-24", "May-24", etc. (customize if you want)
    label = paste0(month, "/", substr(year, 3, 4)),
    time_index = row_number()   # for ordering / gradients if needed
  )

ggplot(month_centroids, aes(x = NMDS1, y = NMDS2)) +
  geom_path(
    aes(group = 1),           # follow the arranged order
    arrow = arrow(length = unit(0.25, "cm")),
    linewidth = 0.7
  ) +
  geom_point(aes(color = year), size = 3) +
  geom_text_repel(aes(label = label, color = year),
                  size = 3, fontface = "bold", show.legend = FALSE) +
  theme_classic() +
  labs(
    title = "Temporal trajectory of benthic community composition",
    x = "NMDS1",
    y = "NMDS2",
    color = "Year"
  ) +
  scale_color_manual(values = c("2024" = "darkblue", "2025" = "red3"))
```
```{r}
library(dplyr)
library(ggplot2)
library(ggrepel)

## 1. Monthly centroids (one point per month Ã— year)
month_centroids <- site_scores_time %>%
  group_by(year, month) %>%
  summarise(
    NMDS1 = mean(NMDS1),
    NMDS2 = mean(NMDS2),
    .groups = "drop"
  ) %>%
  arrange(year, month) %>%
  mutate(
    year  = as.factor(year),
    label = paste0(month, "/", substr(year, 3, 4))
  )

## 2. Clean trajectory plot
ggplot(month_centroids, aes(NMDS1, NMDS2)) +
  # separate path per year, with arrows
  geom_path(aes(group = year, color = year),
            arrow = arrow(type = "closed", length = unit(0.25, "cm")),
            linewidth = 1) +
  # points for each month
  geom_point(aes(color = year), size = 3) +
  # bold month labels
  geom_text_repel(
    aes(label = label, color = year),
    size = 3.5,
    fontface = "bold",
    segment.color = "grey70",
    show.legend = FALSE
  ) +
  scale_color_manual(values = c("2024" = "darkblue", "2025" = "red3")) +
  theme_classic(base_size = 14) +
  labs(
    title = "Temporal trajectory of benthic community composition",
    x = "NMDS1",
    y = "NMDS2",
    color = "Year"
  )

```
```{r}
library(vegan)

## 1. Make sure youâ€™re using the same community matrix used for nmds_time
##    Here I assume itâ€™s called `comm_time_ne`.

species_fit_time <- envfit(nmds_time, comm_ne, permutations = 999)

scores_species <- as.data.frame(scores(species_fit_time, display = "vectors"))
scores_species$species <- rownames(scores_species)
scores_species$pval    <- species_fit_time$vectors$pvals

## keep only significant / top species
sig_species <- scores_species %>%
  filter(pval < 0.05) %>%      # or arrange(pval) %>% slice(1:10)
  arrange(pval)

## 2. Plot: trajectories + species vectors
ggplot(month_centroids, aes(NMDS1, NMDS2)) +
  geom_path(aes(group = year, color = year),
            arrow = arrow(type = "closed", length = unit(0.25, "cm")),
            linewidth = 1) +
  geom_point(aes(color = year), size = 3) +
  geom_text_repel(
    aes(label = label, color = year),
    size = 3.5,
    fontface = "bold",
    segment.color = "grey70",
    show.legend = FALSE
  ) +
  # species vectors
  geom_segment(
    data = sig_species,
    inherit.aes = FALSE,
    aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black"
  ) +
  geom_text_repel(
    data = sig_species,
    inherit.aes = FALSE,
    aes(x = NMDS1, y = NMDS2, label = species),
    size = 3,
    fontface = "bold",
    color = "black",
    segment.color = NA
  ) +
  scale_color_manual(values = c("2024" = "darkblue", "2025" = "red3")) +
  theme_classic(base_size = 14) +
  labs(
    title = "Temporal trajectory with species vectors",
    x = "NMDS1",
    y = "NMDS2",
    color = "Year"
  )

```

>>>>>>> 2498d9ab43915c538e018bab39c49e6dd32e8001
#Algal cover data 
```{r}
cover_data <- doc_MASTER %>%
  filter(data_type == "algal_cover") %>%
  dplyr::select(c(Date, month, ARKEV_type, ARKEV_unit, data_type, species_code,percent)) 

cover_filled <- cover_data %>%
  group_by(Date, ARKEV_unit) %>%
  mutate(total_cover = sum(percent, na.rm = TRUE)) %>%
  ungroup()

#creating new rows with BR to add up total cover to 100%
br_rows <- cover_filled %>%
  distinct(month,ARKEV_type, ARKEV_unit, data_type, total_cover) %>%
  filter(total_cover < 100) %>%
  mutate(
    species_code = "BR",
    percent = 100 - total_cover
  ) %>%
  select(month, ARKEV_type, ARKEV_unit, data_type, species_code, percent)

#final fixed df
cover_final <- bind_rows(cover_filled %>% select(-total_cover), br_rows) %>%
  arrange(month,ARKEV_unit, species_code)

#averaging % cover across units 
mean_cover <- cover_final %>%
  group_by(month, ARKEV_type, species_code) %>%
  summarise(mean_cover = mean(percent))


#organizing
mean_cover$species_code <- reorder(
  mean_cover$species_code,
  -mean_cover$mean_cover,
  FUN = sum)

#plot
ggplot(mean_cover, aes(x = factor(month),
                           y = mean_cover,
                           fill = species_code)) +
  geom_col(position = "stack") +
  facet_wrap(~ ARKEV_type) +
  theme_classic() +
  labs(
    title = "Benthic Cover Composition by ARKEV Type and Month",
    x = "Month",
    y = "% Cover",
    fill = "Species")

#relative cover
relative_cover <- mean_cover %>%
  group_by(month, ARKEV_type) %>%
mutate(relative_cover = (mean_cover / sum(mean_cover)) * 100
  ) %>%
  ungroup()

#ordering
relative_cover$species_code <- factor(relative_cover$species_code,
  levels = c("BS", "SCUM", "TURF", "FLESHY", "ER", "ARTCOR", "CRUCOR","BR"))


#plot
ggplot(relative_cover, aes(x = factor(month),
                           y = relative_cover,
                           fill = species_code)) +
  geom_col(position = "stack") +
  facet_wrap(~ ARKEV_type) +
  theme_classic() +
  labs(
    title = "Relative Cover Composition by ARKEV Type and Month",
    x = "Month",
    y = "Relative % Cover",
    fill = "Species"
  ) +
  scale_fill_manual(
    values = c(
      "BR" = "lightgrey",     # grey for bare rock
      "BS" = "navajowhite" ,#sand
      "CRUCOR" = "mediumpurple2", # crustose
      "ER" = "firebrick",     # encrusting
      "FLESHY" = "red2", # fleshy
      "SCUM" = "#d95f02",   # pink
      "ARTCOR" = "#e7298a",  # olive
      "TURF" = "#1b9e77"
    )
  )  

```

##plot average 
```{r}
first_last <- relative_cover %>%
  filter(month %in% c(4, 9))


ggplot(first_last, aes(x = ARKEV_type,
                       y = relative_cover,
                       fill = species_code)) +
  geom_col(position = "stack") +
  facet_wrap(~ month) +
  theme_classic() +
  labs(
    title = "Relative Algal Cover Composition by ARKEV Type (Months 4 & 9)",
    x = "ARKEV Type",
    y = "Relative % Cover",
    fill = "Species"
  ) +
  scale_fill_manual(
    values = c(
      "BR" = "lightgrey",     # grey for bare rock
      "BS" = "navajowhite" ,#sand
      "CRUCOR" = "mediumpurple2", # crustose
      "ER" = "firebrick",     # encrusting
      "FLESHY" = "red2", # fleshy
      "SCUM" = "#d95f02",   # pink
      "ARTCOR" = "#e7298a",  # olive
      "TURF" = "#1b9e77"
    )
  )  

```
```{r}
change_table <- first_last %>%
  select(month, ARKEV_type, species_code, mean_cover, relative_cover) %>%
  pivot_wider(
    names_from = month,
    values_from = c(mean_cover, relative_cover),
    names_prefix = ""
  ) %>%
  # Replace NAs with 0 for missing species-month combinations
  mutate(across(starts_with("mean_cover_"), ~replace_na(., 0)),
         across(starts_with("relative_cover_"), ~replace_na(., 0))) %>%
  # Compute change (Month 9 - Month 4)
  mutate(
    change_mean_cover = mean_cover_9 - mean_cover_4,
    change_relative_cover = relative_cover_9 - relative_cover_4
  ) %>%
  # Arrange neatly
  arrange(ARKEV_type, species_code)

# View table
change_table

```

#fish analyses
```{r}
fish_raw = read_sheet('https://docs.google.com/spreadsheets/d/1FhmZUcguN4L9MZjXnjwAShoP-qjgkM_PSHA_7za174o/edit')

fish_raw = fish_raw %>%
  mutate(size_cm = as.numeric(as.character(size_cm)))

fish = read_sheet('https://docs.google.com/spreadsheets/d/15xPzazEZGQmVRTvH-H0jDeKfVJEajeiBuO3p0F8dS_M/edit?gid=0#gid=0')

fish = fish %>%
  mutate(
    month = format(date, "%b"),
    treatment = recode(treatment,
                       "ARKEV" = "ARKEV",
                       "ARKEV_control" = "Control",
                       "fish_control" = "Blank_ARKEV")
  )

fish$month <- factor(fish$month, 
                     levels = intersect(month.abb, unique(fish$month)))
str(fish)
```

```{R}
library(ggplot2)
fish_monthly <- fish %>%
  filter(month != "Oct") %>%
  group_by(treatment, month) %>%
  summarise(
    mean_richness = mean(species_richness, na.rm = TRUE),
    se_richness   = sd(species_richness, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

treat_colors <- c(
  "ARKEV" = "#BA5A4A",
  "Blank_ARKEV" = "#F4A14E",
  "Control" = "#F9A38C"
)

ggplot(fish_monthly, aes(x = month, y = mean_richness, color = treatment, group = treatment)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_richness - se_richness,
                    ymax = mean_richness + se_richness),
                width = 0.2) +
  labs(
    title = "Average Species Richness by Month",
    x = "Month",
    y = "Mean Species Richness",
    color = "Treatment"
  ) +
    scale_color_manual(values = treat_colors) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

ggplot(fish_monthly, aes(x = month, y = mean_richness, 
                               fill = treatment)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = mean_richness - se_richness,
                    ymax = mean_richness + se_richness),
                width = 0.2,
                position = position_dodge(width = 0.8)) +
  
  labs(
    title = "Average Species Richness by Month",
    x = "Month",
    y = "Mean Species Richness",
    color = "Treatment") +
    scale_fill_manual(values = treat_colors) +
  theme_bw()
```

```{r}
fish_treat_summary <- fish %>%
  group_by(treatment, location) %>%
  summarise(
    mean_richness = mean(species_richness, na.rm = TRUE),
    se_richness   = sd(species_richness, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

ggplot(fish_treat_summary, 
       aes(x = treatment, y = mean_richness, fill = treatment)) +
  geom_bar(stat = "identity", color = "black", width = 0.7) +
  geom_errorbar(aes(
      ymin = mean_richness - se_richness,
      ymax = mean_richness + se_richness
    ),
    width = 0.2,
    size = 0.7
  ) +
  scale_fill_manual(values = treat_colors) +
  theme_bw(base_size = 14) +
  labs(title = "Average Species Richness by Treatment",
    x = "Treatment",
    y = "Average Species Richness",
    fill = "Treatment"
  )

fish_treat_summary$location <- factor(
  fish_den_summary$location,
  levels = c("fish_on", "fish_off"))

trt_loc_colors <- c(
  "fish_on"       = "#BA5A4A",
  "fish_off" = "#F4A14E"
)

ggplot(fish_treat_summary, 
       aes(x = treatment, y = mean_richness, fill = location)) +
  geom_bar(
    stat = "identity", 
    color = "black", 
    width = 0.7, 
    position = position_dodge(width = 0.8)
  ) +
  geom_errorbar(
    aes(
      ymin = mean_richness - se_richness,
      ymax = mean_richness + se_richness
    ),
    width = 0.2,
    size = 0.7,
    position = position_dodge(width = 0.8)
  ) +
  scale_fill_manual(values = trt_loc_colors) +
  theme_bw(base_size = 14) +
  labs(
    title = "Average Species Richness by Treatment",
    x = "Treatment",
    y = "Average Species Richness",
    fill = "Location"
  )

```

```{r}
library(glmmTMB)
library(DHARMa)

fish <- fish %>%
  mutate(
    treatment = factor(treatment),
    location  = factor(location),
    ARKEV_ID  = factor(ARKEV_ID),
    date      = factor(date)   # use factor for random effect
  )
```

```{r}
rich_m_nb <- glmmTMB(
  species_richness ~ treatment * location +
    (1 | ARKEV_ID) +
    (1 | date),
  family = nbinom2(link = "log"),
  data = fish
)
summary(rich_m_nb)
```



```{r}
library(ggplot2)

fish_treat_summary <- fish_treat_summary %>%
  mutate(Letter = case_when(
    treatment == "ARKEV" ~ "A",
    treatment == "Control" ~ "B",
    treatment == "Blank_ARKEV" ~ "AB"
  ))

treat_colors <- c(
  "ARKEV"       = "#BA5A4A",
  "Blank_ARKEV" = "#F4A14E",
  "Control"     = "#F9A38C"
)


ggplot(fish_treat_summary, aes(x = treatment, y = mean_richness, fill = treatment)) +
  geom_bar(stat = "identity", color = "black", width = 0.7) +
  geom_errorbar(aes(ymin = mean_richness - se_richness,
                    ymax = mean_richness + se_richness),
                width = 0.2) +
  geom_text(aes(label = Letter, y = mean_richness + se_richness + 0.2), size = 5) +
  scale_fill_manual(values = treat_colors) +
  theme_bw(base_size = 14) +
  labs(title = "Average Species Richness by Treatment",
    x = "Treatment",
    y = "Average Species Richness",
    fill = "Treatment"
  )
```

```{r}
fish_den_monthly <- fish %>%
  filter(month != "Oct") %>%
  group_by(treatment, month) %>%
  summarise(
    mean_density = mean(fish_density, na.rm = TRUE),
    se_density  = sd(fish_density, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

den_treat_colors <- c(
  "ARKEV"       = "#1B9E77",
  "Blank_ARKEV" = "#D95F02",
  "Control"     = "#7570B3"
)

ggplot(fish_den_monthly, aes(x = month, y = mean_density, color = treatment, group = treatment)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_density - se_density,
                    ymax = mean_density + se_density),
                width = 0.2) +
  labs(
    title = "Average # of Fish by Treatment by Month",
    x = "Month",
    y = "Mean Fish Density",
    color = "Treatment"
  ) +
    scale_color_manual(values = den_treat_colors) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

ggplot(fish_den_monthly, aes(x = month, y = mean_density, 
                               fill = treatment)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = mean_density - se_density,
                    ymax = mean_density + se_density),
                width = 0.2,
                position = position_dodge(width = 0.8)) +
  labs(
    title = "Average # of Fish by Treament by Month",
    x = "Month",
    y = "Mean Fish Density",
    color = "Treatment") +
    scale_fill_manual(values = den_treat_colors) +
  theme_bw()
```

```{r}
fish_den_summary <- fish %>%
  group_by(treatment, location) %>%
  summarise(
    mean_density = mean(fish_density, na.rm = TRUE),
    se_density   = sd(fish_density, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

den_loc_colors <- c(
  "fish_on"       = "darkgreen",
  "fish_off" = "lightblue"
)

fish_den_summary$location <- factor(
  fish_den_summary$location,
  levels = c("fish_on", "fish_off"))

ggplot(fish_den_summary, 
       aes(x = treatment, y = mean_density, fill = location )) +
  geom_bar(stat = "identity", color = "black", width = 0.7, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = mean_density - se_density,
                    ymax = mean_density + se_density),
                position = position_dodge(width = 0.8),
    width = 0.2,
    size = 0.7
  ) +
  scale_fill_manual(values = den_loc_colors) +
  theme_bw(base_size = 14) +
  labs(title = "Average Number of Fish by Treatment",
    x = "Treatment",
    y = "Average Fish Density",
    fill = "Location"
  )
```

```{r}
library(glmmTMB)
library(DHARMa)

fish <- fish %>%
  mutate(
    treatment = factor(treatment),
    location  = factor(location),
    ARKEV_ID  = factor(ARKEV_ID),
    date      = factor(date)   # use factor for random effect
  )
```

```{r}
m_nb <- glmmTMB(
  fish_density ~ treatment * location +
    (1 | ARKEV_ID) +
    (1 | date),
  family = nbinom2(link = "log"),
  data = fish
)
summary(m_nb)
```
```{r}
library(emmeans)

emmeans(m_nb, pairwise ~ treatment * location, type = "response")
```
```{r}
library(emmeans)
library(ggplot2)

# Estimated marginal means on response scale (not log)
emm <- emmeans(m_nb, ~ treatment * location, type = "response")

# Convert to data frame for ggplot
emm_df <- as.data.frame(emm)
str(emm_df)

# Plot
ggplot(emm_df,
       aes(x = treatment, y = response,
           color = location, group = location)) +
  geom_point(position = position_dodge(width = 0.3), size = 3) +
  geom_line(position = position_dodge(width = 0.3), size = 1) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.15,
                position = position_dodge(width = 0.3)) +
  labs(
    y = "Predicted Fish Density",
    x = "Treatment",
    color = "Location",
    title = "Treatment Ã— Location Interaction (Negative Binomial GLMM)"
  )  +
  theme_bw(base_size = 14)
```
