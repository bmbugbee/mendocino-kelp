---
title: "ARKEV analyses"
output: pdf_document
date: "2025-10-24"
---
```{r}
#installing packages
library(dplyr)
library(tidyr)
library(lubridate)
library(googlesheets4)
library(purrr)

#importing datasheet 
MASTER = read_sheet('https://docs.google.com/spreadsheets/d/1jhqeuVwg7_icGaYOh5YpMcoPubQsDs3fn9fWGcZmFi4/edit?gid=1766421584#gid=1766421584')

#creating the function that converts "NAs" to true NAs
to_numeric <- function(x) {
  map_dbl(x, ~ {
    # empty list → NA
    if (length(.x) == 0) return(NA_real_)
    
    # if it's character, convert "NA" → NA first
    if (is.character(.x)) {
      .x <- na_if(.x, "NA")
    }
    as.numeric(.x)
  })
}

doc_MASTER <- MASTER %>%
# turn "NA" strings in character columns into real NA
  mutate(across(where(is.character), ~ na_if(.x, "NA"))) %>%
# list-columns that are truly numeric-ish
  mutate(
    count   = to_numeric(count),
    percent = to_numeric(percent),
    depth_ft = to_numeric(depth_ft),
    temp_f   = to_numeric(temp_f)
  ) %>%
# handle size_cm specially
  mutate(
# keep the original category (<2cm, >2cm, numbers) as a character column "urchin_size_class"
    urch_size_class = map_chr(size_cm, ~ {
      if (length(.x) == 0) return(NA_character_)
      as.character(.x)
    }),
# numeric version: fish lengths only; urchin categories → NA
    size_cm = map_dbl(size_cm, ~ {
      if (length(.x) == 0) return(NA_real_)
      if (is.character(.x)) {
# drop urchin categories from numeric column
        if (.x %in% c("<2cm", ">2cm")) return(NA_real_)
        .x <- na_if(.x, "NA")
      }
      as.numeric(.x)
    })
  ) %>%
  mutate(Date = make_date(year, month, day))
```

```{r}

kelp_data_full <- doc_MASTER %>%
  filter(data_type == "kelp")%>%
  # Fill in missing combos of ARKEV_type × Date × species_code
  complete(month, day, year, ARKEV_type, ARKEV_unit, data_type, Date, species_code, fill = list(count = 0))

  

kelp_summary_full <- kelp_data_full %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

kelp_data <- doc_MASTER %>%
  filter(data_type == "kelp")%>%
  filter(month != 10) %>%
  # Fill in missing combos of ARKEV_type × Date × species_code
  complete(month, day, year, ARKEV_type, ARKEV_unit, data_type, Date, species_code, fill = list(count = 0))

kelp_summary <- kelp_data %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )
View(kelp_data_full)
```

```{r}
library(ggplot2)

ggplot(kelp_summary_full, aes(x = Date, y = mean_count, color = ARKEV_type, group = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))

#Removing October Month 
ggplot(kelp_summary, aes(x = Date, y = mean_count, color = ARKEV_type, group = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))
```
```{r}
kelp_total_abundance <- kelp_summary %>%
  group_by(ARKEV_type) %>%
  summarise(
    mean_count = mean(mean_count, na.rm = TRUE),                 # average over dates
    se_count = sqrt(sum(se_count^2) / n()),                     # combine SE across dates
    .groups = "drop"
  )
```

```{r}
library(ggplot2)

ggplot(kelp_total_abundance, aes(x = ARKEV_type, y = mean_count)) +
  geom_col(color = "black", show.legend = FALSE) +
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
                width = 0.3, color = "black") +
  labs(
    title = "Overall Mean Kelp Abundance by ARKEV Type",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per m²)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
```

```{r}
kelp_species_summary <- kelp_data %>%
  filter(!species_code %in% c("NO_KELP", "STUMP")) %>%
  group_by(Date, ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

kelp_monthly <- kelp_species_summary %>%
  group_by(Date, ARKEV_type) %>%
  mutate(
    percent_count = (mean_count / sum(mean_count)) * 100
  ) %>%
  ungroup()

```

```{r}
library(ggplot2)

ggplot(kelp_species_summary, aes(x = Date, y = mean_count, fill = species_code)) +
  geom_col(position = "stack", color = "black") +
  facet_wrap(~ ARKEV_type) +
  labs(
    title = "Kelp Species Composition by ARKEV Type Over Time",
    x = "Date",
    y = "Mean Kelp Count (per m²)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  )

library(ggplot2)

ggplot(kelp_monthly, aes(x = Date, y = percent_count, fill = species_code)) +
  geom_col(color = "black", position = "stack") +
  facet_wrap(~ ARKEV_type) +
  labs(
    title = "Relative Kelp Species Composition",
    x = "Month",
    y = "Percent of Total Kelp (%)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10, face = "bold")
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))


```

```{r}
kelp_total <- kelp_data %>%
  group_by(ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE), 
    se_count = sd(count, na.rm = TRUE)/ sqrt(n()),
    .groups = "drop"
  )

kelp_total <- kelp_total %>%
  group_by(ARKEV_type) %>%
  mutate(
    percent_count = (mean_count / sum(mean_count)) * 100
  ) %>%
  ungroup()

```

```{r}
library(ggplot2)

ggplot(kelp_total, aes(x = ARKEV_type, y = percent_count, fill = species_code)) +
  geom_col(color = "black") +
  labs(
    title = "Overall Relative Kelp Species Composition by ARKEV Type",
    x = "ARKEV Type",
    y = "Percent of Total Kelp (%)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))


ggplot(kelp_total, aes(x = ARKEV_type, y = mean_count, fill = species_code)) +
  geom_col(position = "stack", color = "black") +
  labs(
    title = "Mean Kelp Species Abundance by ARKEV Type",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per m²)",
    fill = "Species Code"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12, face = "bold")
  )

```

```{r}
kelp_data_clean <- kelp_data %>%
  filter(!species_code %in% c("NO_KELP", "STUMP"))

kelp_richness <- kelp_data_clean %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    richness = n_distinct(species_code[!is.na(count) & count > 0]),
    .groups = "drop"
  )

kelp_abundance <- kelp_data_clean %>%
  group_by(ARKEV_type, Date) %>%
  summarise(
    mean_abundance = mean(count, na.rm = TRUE),
    .groups = "drop"
  )
```

#kelp richness
```{r}
# Check normality
shapiro.test(kelp_richness$richness[kelp_richness$ARKEV_type == "ARKEV"])
shapiro.test(kelp_richness$richness[kelp_richness$ARKEV_type == "ARKEV_control"])

# Compare richness
t.test(richness ~ ARKEV_type, data = kelp_richness, var.equal = TRUE)
# or, if non-normal:
wilcox.test(richness ~ ARKEV_type, data = kelp_richness)
```

#kelp abundance
```{r}
# Check normality
shapiro.test(kelp_abundance$mean_abundance[kelp_abundance$ARKEV_type == "ARKEV"])
shapiro.test(kelp_abundance$mean_abundance[kelp_abundance$ARKEV_type == "ARKEV_control"])

# Compare abundance
t.test(mean_abundance ~ ARKEV_type, data = kelp_abundance, var.equal = TRUE)
# or nonparametric:
wilcox.test(mean_abundance ~ ARKEV_type, data = kelp_abundance)
```

#nereo recruits
```{r}
nereo <- kelp_data %>%
  filter(species_code %in% c("NERJ", "NERA", "LAMR"))

str(nereo)

nereo_summary <- nereo %>%
  group_by(Date, ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )
```

```{r}
nereo_aov <- aov(mean_count ~ ARKEV_type * species_code, data = nereo_summary)
summary(nereo_aov)
```

```{r}
TukeyHSD(nereo_aov)
```

```{r}
# NERJ
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "NERJ"))

# NERA
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "NERA"))

# LAMR
t.test(count ~ ARKEV_type, data = kelp_data_clean %>% filter(species_code == "LAMR"))
```

```{r}
library(ggplot2)
kelp_means <- nereo %>%
  filter(species_code %in% c("NERA", "NERJ", "LAMR")) %>%
  group_by(ARKEV_type, species_code) %>%
  summarise(
    mean_count = mean(count, na.rm = TRUE),
    se_count = sd(count, na.rm = TRUE) / sqrt(sum(!is.na(count))),
    .groups = "drop"
  )

ggplot(kelp_means, aes(x = ARKEV_type, y = mean_count, fill = species_code)) +
  geom_col(position = position_dodge(width = 0.9), color = "black") +
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  labs(
    title = "Bull Kelp Abundance Across ARKEV Types",
    x = "ARKEV Type",
    y = "Mean Kelp Count (per m²)",
    fill = "Species"
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12)
  )

ggplot(nereo_summary, aes(x = Date, y = mean_count, color = species_code, linetype = ARKEV_type)) +
  geom_point(position = position_dodge(width = 0.8), size = 2) +
  geom_line(size=1)+
  geom_errorbar(
    aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
    position = position_dodge(width = 0.8),
    width = 0.3, size=1
  ) +
  labs(
    title = "Kelp Counts by ARKEV Presence",
    x = "Date",
    y = "Mean Kelp Count (per m^2)",
    fill = "Site Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.title = element_text(size=12, face= "bold"),
    legend.text = element_text(size=12, face= "bold"))
```


#blade number and reproductivity
```{r}

library(purrr)
#big river
br_kelp_MASTER = read_sheet('https://docs.google.com/spreadsheets/d/1mLYdDFh0XjEMPe9db5vKZzQMHRzRLlC-7fostoIXkM0/edit?gid=0#gid=0')

glimpse(br_kelp_MASTER)

# Helper function: safely convert list elements to numeric
to_numeric <- function(x) {
  map_dbl(x, ~ {
    # empty list → NA
    if (length(.x) == 0) return(NA_real_)
    
    # if it's character, convert "NA" → NA first
    if (is.character(.x)) {
      .x <- na_if(.x, "NA")
    }
    as.numeric(.x)
  })
}

br_kelp <- br_kelp_MASTER %>%
  mutate(
    site = "Big River",
    kelp_on_ARKEV = to_numeric(kelp_on_ARKEV),
    stipe_length = to_numeric(stipe_length),
    reproductive_kelp_on_ARKEV = to_numeric(reproductive_kelp_on_ARKEV),
    blade_number = to_numeric(blade_number),
    reproductive_blade_number = to_numeric(reproductive_blade_number)
  ) %>%
  filter(!is.na(kelp_on_ARKEV))

(br_kelp)

br_clean <- br_kelp %>%
  mutate(date = as.Date(paste(year, month, day, sep = "-"), format = "%Y-%m-%d"))%>%
  distinct(site, date, ARKEV_unit, .keep_all = TRUE) %>%
  group_by(site, date) %>%
  mutate(total = sum(kelp_on_ARKEV)) %>%
  select (-c(observer:...17))
print(br_clean)
```

```{r}
library(dplyr)
library(lubridate)

br_monthly_indiv <- br_clean %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  filter(!is.na(blade_number) & !is.na(reproductive_blade_number))%>%
  group_by(site, month, ARKEV_unit) %>%
  summarise(
    mean_blade_number = mean(blade_number, na.rm = TRUE),
    mean_repro_blades = mean(reproductive_blade_number, na.rm = TRUE),
    percent_fertile = ifelse(mean_blade_number > 0,
                             (mean_repro_blades / mean_blade_number) * 100, NA),
    .groups = "drop"
  ) %>%
  mutate(mean_spores_hr1 = 456111.1,
         se_spores_hr1 = 143536.1,
         mean_spores_hr2 = 450277.8,
         se_spores_hr2 = 108371.3,
         reproductive_output = mean_repro_blades * (mean_spores_hr1/3))

```

```{r}
br_monthly_total <- br_clean %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  filter(!is.na(blade_number) & !is.na(reproductive_blade_number))%>%
group_by(month) %>%
  summarise(
       total = mean(total),
       mean_blade_number = mean(blade_number, na.rm = TRUE),
       mean_repro_blades = mean(reproductive_blade_number, na.rm = TRUE),
       percent_fertile = ifelse(mean_blade_number > 0,
                             (mean_repro_blades / mean_blade_number) * 100, NA),
       total_repro_blades = mean_repro_blades * total,
       estimated_sori_released_4day = mean(reproductive_blade_number, na.rm = TRUE) * 7.5,
       estimated_sori_released_6day = mean(reproductive_blade_number, na.rm = TRUE) * 5,
    .groups = "drop"
  )%>%
  mutate(mean_spores_hr1 = 456111.1,
         se_spores_hr1 = 143536.1,
         mean_spores_hr2 = 450277.8,
         se_spores_hr2 = 108371.3,
         reproductive_output_4day = estimated_sori_released_4day * (mean_spores_hr1/3),
         reproductive_output_6day = estimated_sori_released_6day * (mean_spores_hr1/3))

# Transpose the data frame
br_mt_transposed <- as.data.frame(t(br_monthly_total))

write.csv(br_mt_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_mt_transposed.csv", 
          row.names = TRUE)

```

```{r}
br_repro_total <- br_monthly_total %>%
  summarise(
    mean_blade_number = mean(mean_blade_number, na.rm = TRUE),
    mean_repro_blades = mean(mean_repro_blades, na.rm = TRUE),
    percent_fertile = mean(percent_fertile),
    total_repro_blades = mean(total_repro_blades),
    mean_sori_4day = mean(estimated_sori_released_4day, na.rm = TRUE),
    se_sori_4day = sd(estimated_sori_released_4day, na.rm = TRUE) / sqrt(n()),
    mean_sori_6day = mean(estimated_sori_released_6day, na.rm = TRUE),
    se_sori_6day = sd(estimated_sori_released_6day, na.rm = TRUE) / sqrt(n()),
    mean_spores_4day = mean(reproductive_output_4day, na.rm = TRUE),
    se_spores_4day = sd(reproductive_output_4day, na.rm = TRUE) / sqrt(n()),
    mean_spores_6day = mean(reproductive_output_6day, na.rm = TRUE),
    se_spores_6day = sd(reproductive_output_6day, na.rm = TRUE) / sqrt(n())
  )

# Transpose the data frame
br_repro_transposed <- as.data.frame(t(br_repro_total))

write.csv(br_repro_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_repro_transposed.csv", 
          row.names = TRUE)
```

```{r}
br_estimate <- br_monthly_total %>%
  summarise(
    mean_sori_4day_total = mean(estimated_sori_released_4day, na.rm = TRUE) * 22.75,
    se_sori_4day_total = sd(estimated_sori_released_4day, na.rm = TRUE) / sqrt(n()) * 22.75,
    
    mean_sori_6day_total = mean(estimated_sori_released_6day, na.rm = TRUE) * 15,
    se_sori_6day_total = sd(estimated_sori_released_6day, na.rm = TRUE) / sqrt(n()) * 15,
    
    mean_spores_4day_total = mean(reproductive_output_4day, na.rm = TRUE) * 22.75,
    se_spores_4day_total = sd(reproductive_output_4day, na.rm = TRUE) / sqrt(n()) * 22.75,
    
    mean_spores_6day_total = mean(reproductive_output_6day, na.rm = TRUE) * 15,
    se_spores_6day_total = sd(reproductive_output_6day, na.rm = TRUE) / sqrt(n()) * 15
  )

br_estimate_transposed <- as.data.frame(t(br_estimate))

write.csv(br_estimate_transposed, "C:/Users/bmbug/OneDrive/Documents/MLML recovered/Bull Kelp Project/data/2025/br_estimate_transposed.csv", 
          row.names = TRUE)

```


#Kelp biomass data
```{r}
biomass = read.csv("ARKEV harvest.csv", header =TRUE)
biomass <- biomass %>%
  mutate(
    Stipe_length = as.numeric(Stipe_length),
    Weight = as.numeric(Weight),
    Total.Blades = as.numeric(Total.Blades),
    Reproductive_blades = as.numeric(Reproductive_blades)
  )
str(biomass)
```

```{r}
library(dplyr)

# Filter for Noyo site
noyo_data <- biomass %>%
  filter(Site == "Noyo")

# Summarize total biomass and mean ± SE
noyo_biomass <- noyo_data %>%
  summarise(
    total_biomass = sum(Weight, na.rm = TRUE),          # total biomass (g)
    mean_biomass = mean(Weight, na.rm = TRUE),         # mean biomass per individual
    se_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))  # standard error
  )

noyo_arkev_biomass <- noyo_data %>%
  group_by(Unit)%>%
  summarize(
    total_biomass = sum(Weight, na.rm = TRUE),
    mean_biomass = mean(Weight, na.rm = TRUE),        
    se_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))  
  )

noyo_per_unit_summary <- noyo_arkev_biomass %>%
  summarise(
    mean_unit_biomass = mean(total_biomass, na.rm = TRUE),
    se_unit_biomass = sd(total_biomass, na.rm = TRUE) / sqrt(sum(!is.na(total_biomass)))
  )

```

```{r}
# Filter Big River data
br_biomass <- biomass %>%
  filter(Site == "Big River")

#Per ARKEV unit biomass
br_per_unit <- br_biomass %>%
  group_by(Unit) %>%
  summarise(
    unit_biomass = sum(Weight, na.rm = TRUE)
  )

br_per_unit_summary <- br_per_unit %>%
  summarise(
    mean_unit_biomass = mean(unit_biomass, na.rm = TRUE),
    se_unit_biomass = sd(unit_biomass, na.rm = TRUE) / sqrt(sum(!is.na(unit_biomass)))
  )


#Per individual kelp biomass
br_per_kelp_summary <- br_biomass %>%
  summarise(
    mean_kelp_biomass = mean(Weight, na.rm = TRUE),
    se_kelp_biomass = sd(Weight, na.rm = TRUE) / sqrt(sum(!is.na(Weight)))
  )

br_total_df <- br_clean %>%
  distinct(date, .keep_all = TRUE) %>%
  select(date, total)

str(br_total_df)

#Estimate total biomass for Big River using mean per kelp * total kelp count
br_final_biomass <- br_per_kelp_summary$mean_kelp_biomass * 179
br_arkev_final <- br_per_unit_summary$mean_unit_biomass * 44


```

```{r}
library(dplyr)
library(ggplot2)

# Add a Site column to each summary
noyo_plot_data <- noyo_per_unit_summary %>%
  mutate(Site = "Noyo")

br_plot_data <- br_per_unit_summary %>%
  mutate(Site = "Big River")

# Combine both
combined_plot_data <- bind_rows(noyo_plot_data, br_plot_data)

# Make bar plot with SE
ggplot(combined_plot_data, aes(x = Site, y = mean_unit_biomass, fill = Site)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_errorbar(aes(ymin = mean_unit_biomass - se_unit_biomass,
                    ymax = mean_unit_biomass + se_unit_biomass),
                width = 0.2) +
  labs(y = "Mean ARKEV Unit Biomass (kg)", x = "",
       title = "ARKEV Kelp Biomass by Site") +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold", hjust = 0.5, vjust=1),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 15, face = "bold"), 
    title = element_text(size = 15, face = "bold"),
    legend.position = "none")
```

#Urchin size class data
```{r}
urch_data <- doc_MASTER %>%
  filter(data_type == "urchins") %>%
  dplyr::select(c(Date, month, ARKEV_type, ARKEV_unit, data_type, species_code, count, urch_size_class, substrate, depth_ft, temp_f, visibility_m)) %>%
  mutate(density = count/pi) 

#just purps
purps_data <- urch_data %>%
  filter(species_code == "STRPUR") %>% # only purps
filter(!(month == 10 & ARKEV_type == "ARKEV" & urch_size_class == "NA"), 
       !(month == 8 & ARKEV_type == "ARKEV" & count == "NA"))

purps_summary <- purps_data %>%
 group_by(month, ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))
View(purps_data)
```

##ARKEV vs. Control over time 
```{r}
purps_summary <- purps_summary %>%
  mutate(month = factor(month, levels = 4:10, labels = c("Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct")))



ggplot(
  purps_summary,
  aes(
    x = month,
    y = mean_density,
    color = urch_size_class,
    linetype = ARKEV_type,
    group = interaction(ARKEV_type, urch_size_class)
  )
) +
  geom_line(linewidth = 1.5) +
  geom_errorbar(
    aes(ymin = mean_density - sd_density,
        ymax = mean_density + sd_density),
    width = 0.1,      # small horizontal width for visual clarity
    size = 0.8) +
  scale_linetype_manual(values = c("ARKEV" = "solid", "ARKEV_control" = "dashed")) +
  scale_color_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Month",
    y = "Purple urchin density (indv/m²)",
    color = "Size class",
    linetype = "Treatment"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    axis.text = element_text(color = "black"),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 12),
    axis.line = element_line(size = 0.4),
    panel.grid = element_blank()
  )

```

#stats (LLM)
```{r}


#checking distrubution of density data
ggplot(purps_data, aes(x = density)) +
  geom_histogram(aes(y = ..density..), bins = 30, alpha = 0.5) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of Urchin Density",
       x = "Urchin density (indv/m²)",
       y = "Density") +
  theme_classic()

ggplot(purps_data, aes(sample = density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()

shapiro.test(purps_data$density) #NOT NORMALLY DISTRIBUTED

#log transformation
purps_data_log <- purps_data %>%
  mutate(log_density = log(density + 1))

shapiro.test(purps_data_log$log_density)
ggplot(purps_data_log, aes(sample = log_density)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Urchin Density") +
  theme_classic()


library(lme4)
library(lmerTest)

purps_data_log <- purps_data_log %>%
  mutate(month_f = factor(month))

#Model
full_mod <- lmer(
  log_density ~ month_f * ARKEV_type * urch_size_class + (1 | ARKEV_unit),
  data = purps_data_log
)

summary(full_mod)
  #
anova(full_mod)

library(emmeans)

# Get model predictions

emm_effects <- emmeans(full_mod,~ ARKEV_type | month_f * urch_size_class)

# ARKEV vs control difference at each month × size class:
treat_diff <- contrast(emm_effects, method = "revpairwise")  # control - ARKEV or vice versa
treat_diff

```
##ARKEV vs. Control 
```{r}
purp_by_type <- purps_data %>%
  group_by(ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))

ggplot(
  purp_by_type,
  aes(x = ARKEV_type, y = mean_density, fill = urch_size_class)) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Treatment",
    y = "Purple urchin density (indv/m²)",
    fill = "Size class"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )
```
#stats(AOV)
```{r}
aov_purp_density <- aov(
  log_density ~ ARKEV_type * urch_size_class,
  data = purps_data_log
)
summary(aov_purp_density)

TukeyHSD(aov_purp_density)

#significant interactions
##ARKEV: >2cm - ARKEV: <2cm
##ARKEV_control: >2cm - ARKEV: <2cm
##ARKEV: >2cm - ARKEV_control: <2cm 
##ARKEV_control: >2cm - ARKEV_control: <2cm

```
#ARKEV vs. Control vs. ARKEV w/ drift
```{r}
#creating a df with three treatment types 
treatments <- purps_data %>%
  mutate(
    ARKEV_type = case_when(
      ARKEV_unit %in% c("2A", "2C", "2E", 
                        "3A", "3C", "3E",
                        "5A", "5C", "5E",
                        "6A", "6C", "6E",
                        "7A", "7C", "7E") ~ "ARKEV_drift",
      TRUE ~ ARKEV_type)) # keep existing values for all other units

treatment_density <- treatments %>%
  group_by(ARKEV_type, urch_size_class) %>%
  summarise(
    mean_density = mean(density, na.rm = TRUE),
    sd_density = sd(density, na.rm = TRUE))

ggplot(treatment_density, aes(x = ARKEV_type, y = mean_density, fill = urch_size_class)) +
  geom_col(position = position_dodge(0.9), width = 0.7, color = "black") +
  geom_errorbar(
    aes(
      ymin = mean_density - sd_density,
      ymax = mean_density + sd_density
    ),
    position = position_dodge(0.9),
    width = 0.2
  ) +
  scale_fill_manual(values = c("<2cm" = "#1b9e77", ">2cm" = "#d95f02")) +
  labs(
    x = "Treatment",
    y = "Purple urchin density (indv/m²)",
    fill = "Size class"
  ) +
  theme_classic(base_size = 16) +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    panel.grid = element_blank()
  )
```
#stats(AOV)
```{r}
treatments_data_log <- treatments %>%
  mutate(log_density = log(density + 1))

aov_treatment_density <- aov(
  log_density ~ ARKEV_type * urch_size_class,
  data = treatments_data_log
)
summary(aov_treatment_density)

TukeyHSD(aov_treatment_density)

#significant interactions
## ARKEV_drift:<2cm-ARKEV:<2cm 
## ARKEV:>2cm-ARKEV:<2cm  
## ARKEV_control:>2cm-ARKEV_control:<2cm
## ARKEV_drift:>2cm-ARKEV_drift:<2cm
## ARKEV_drift:>2cm-ARKEV:>2cm
## ARKEV_drift:>2cm-ARKEV_control:>2cm 

#There is a significantly greater density of purple urchins of both size classes in the ARKEV with drift plots compared to the ARKEV plots. 
#Across all treatments, density of <2cm is significantly greater than density of >2cm urchins. #Urchin density was only significantly greater in the >2cm ARKEV with drift plots compared to the control plots. 

```

#Benthic community data (BR)
```{r}
benthic_data <- doc_MASTER %>%
filter(data_type == c("urchins", "kelp", "inverts", "tegula")) %>%
  dplyr::select(c(Date, month, ARKEV_type, ARKEV_unit, data_type, species_code, count, urch_size_class, substrate, depth_ft, temp_f, visibility_m)) %>%
  mutate(density = count/pi) 

benthic_data_cleaned <- benthic_data %>%
   mutate( species_code = case_when(
      species_code == "STRPUR" & urch_size_class == "<2cm" ~ "STRPUR_<2cm",
      species_code == "STRPUR" & urch_size_class == ">2cm" ~ "STRPUR_>2cm",
      TRUE ~ species_code
    ) 
  ) %>%
  filter(!(month == 10 & ARKEV_type == "ARKEV" & urch_size_class == "NA"), 
       !(month == 8 & ARKEV_type == "ARKEV" & count == "NA"), 
       !(month == 7 & ARKEV_type == "ARKEV_control" & ARKEV_unit == "C7A" & count == "NA")) %>%
  dplyr::select(-c(urch_size_class:visibility_m))

glimpse(benthic_data_cleaned)
```

#community matrix by block
```{r}
library(vegan)
library(stringr)

benthic_block <- benthic_data_cleaned %>%
  mutate(  
    # remove leading "C" if present (e.g. "C10A" -> "10A")
    clean_unit = str_remove(ARKEV_unit, "^C"),
    # now extract the block number (everything before first letter)
    block = str_extract(clean_unit, "^\\d+")
  )

benthic_comm <- benthic_block %>%
  group_by(ARKEV_type, block, species_code) %>%
  summarise(density = sum(density, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from  = species_code,
    values_from = density,
    values_fill = 0
  ) %>%
  dplyr::select(-NO_INVERTS, -NO_KELP)   # fine to drop these “no organism” codes


# 1. Build meta and comm from the same benthic_comm
meta <- benthic_comm %>%
  dplyr::select(ARKEV_type, block)

comm <- benthic_comm %>%
  dplyr::select(-ARKEV_type, -block)


# 2. Clean comm (replace NAs just in case)
comm[is.na(comm)] <- 0


# 5. Transform for NMDS
comm_trans <- decostand(comm, method = "total") %>% sqrt()


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm_trans, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_trans ~ ARKEV_type, data = meta, method = "bray")
permanova

# 8. Plot NMDS
site_scores <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta)


ggplot() +
  geom_point(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment"
  ) +
  scale_color_manual(values = c("ARKEV" = "blue", "ARKEV_control" = "red")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )

```
#community matrix by unit
```{r}
library(vegan)
library(stringr)

benthic_comm_unit <- benthic_data_cleaned %>%
  group_by(ARKEV_type, ARKEV_unit, species_code) %>%
  summarise(density = sum(density, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from  = species_code,
    values_from = density,
    values_fill = 0
  ) %>%
  dplyr::select(-NO_INVERTS, -NO_KELP)   # fine to drop these “no organism” codes


# 1. Build meta and comm from the same benthic_comm
meta <- benthic_comm_unit %>%
  dplyr::select(ARKEV_type, ARKEV_unit)

comm <- benthic_comm_unit %>%
  dplyr::select(-ARKEV_type, -ARKEV_unit)


# drop samples with no total abundance
keep_rows <- rowSums(comm) > 0
comm <- comm[keep_rows, , drop = FALSE]
meta <- meta[keep_rows, , drop = FALSE]

# drop species that occur in fewer than 2 samples
keep_cols <- colSums(comm > 0) >= 1
comm <- comm[, keep_cols, drop = FALSE]

# 5. Transform for NMDS
comm_trans <- decostand(comm, method = "total") %>% sqrt()


# 6. NMDS
set.seed(123)
nmds_res <- metaMDS(comm_trans, distance = "bray", k = 2)

# 7. PERMANOVA (not significant)
permanova <- adonis2(comm_trans ~ ARKEV_type, data = meta, method = "bray")
permanova

# 8. Plot NMDS
site_scores <- as.data.frame(scores(nmds_res, display = "sites")) %>%
  bind_cols(meta)


ggplot() +
  geom_point(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    size = 3.5, alpha = 0.85
  ) +
  stat_ellipse(
    data = site_scores,
    aes(x = NMDS1, y = NMDS2, color = ARKEV_type),
    type = "t",
    linetype = "solid",
    size = 0.8,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "NMDS1",
    y = "NMDS2",
    color = "Treatment"
  ) +
  scale_color_manual(values = c("ARKEV" = "blue", "ARKEV_control" = "red")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12)
  )

```


